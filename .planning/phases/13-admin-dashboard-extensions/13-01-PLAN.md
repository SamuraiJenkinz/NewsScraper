---
phase: 13-admin-dashboard-extensions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routers/admin.py
  - app/templates/admin/dashboard.html
autonomous: true

must_haves:
  truths:
    - "Dashboard home page shows enterprise API health panel with traffic light status for Auth, News (Factiva), and Equity"
    - "Health panel displays separate last_success and last_failure timestamps per API"
    - "Fallback event log below runs shows last 20 fallback/failure events with timestamp, API, event type, and reason"
  artifacts:
    - path: "app/routers/admin.py"
      provides: "_get_enterprise_api_status() helper querying ApiEvent with last_success + last_failure"
      contains: "_get_enterprise_api_status"
    - path: "app/routers/admin.py"
      provides: "_get_fallback_events() helper for fallback event log"
      contains: "_get_fallback_events"
    - path: "app/templates/admin/dashboard.html"
      provides: "Enterprise API Status panel above category cards + Fallback Event Log section"
      contains: "Enterprise API Status"
  key_links:
    - from: "app/routers/admin.py"
      to: "app/models/api_event.py"
      via: "_get_enterprise_api_status() queries ApiEvent per api_name"
      pattern: "ApiEvent.*api_name"
    - from: "app/templates/admin/dashboard.html"
      to: "app/routers/admin.py"
      via: "Template receives enterprise_status and fallback_events from dashboard route"
      pattern: "enterprise_status"
---

<objective>
Add an enterprise API health panel and fallback event log to the BrasilIntel admin dashboard.

Purpose: Admins need at-a-glance visibility into whether the enterprise APIs (Auth, Factiva, Equity) are working, degraded, or offline — plus a log of recent fallback events. This satisfies ADMN-17 (health panel with last success/failure times).

Output: Updated dashboard route and template showing per-API health status with separate last_success and last_failure timestamps, plus a fallback event log table.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\BrasilIntel\.planning\PROJECT.md
@C:\BrasilIntel\.planning\ROADMAP.md
@C:\BrasilIntel\.planning\STATE.md
@C:\BrasilIntel\.planning\phases\13-admin-dashboard-extensions\13-RESEARCH.md
@C:\BrasilIntel\.planning\phases\13-admin-dashboard-extensions\13-CONTEXT.md

Key existing files to read first:
@C:\BrasilIntel\app\routers\admin.py (current dashboard route at line 334)
@C:\BrasilIntel\app\templates\admin\dashboard.html (current layout)
@C:\BrasilIntel\app\models\api_event.py (ApiEvent model + ApiEventType enum)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enterprise API health panel and fallback event log on dashboard</name>
  <files>app/routers/admin.py, app/templates/admin/dashboard.html</files>
  <action>
Read C:\BrasilIntel\app\routers\admin.py (full file, note the dashboard route at line ~334) and C:\BrasilIntel\app\templates\admin\dashboard.html before making changes.

Also read C:\BrasilIntel\app\models\api_event.py to confirm ApiEventType enum values and field names.

**1. Add helper functions to admin.py (BEFORE the dashboard route):**

Add `_get_enterprise_api_status(db) -> list[dict]`:
- Query ApiEvent table for EACH api_name in ["auth", "news", "equity"] (BrasilIntel does NOT have enterprise email yet — only 3 APIs, not 4).
- Display names: auth="Authentication", news="News (Factiva)", equity="Equity Prices"
- For each api_name, query the MOST RECENT successful event AND the MOST RECENT failed event separately:
  ```python
  last_success = db.query(ApiEvent).filter(
      ApiEvent.api_name == api_name,
      ApiEvent.success == True
  ).order_by(ApiEvent.timestamp.desc()).first()

  last_failure = db.query(ApiEvent).filter(
      ApiEvent.api_name == api_name,
      ApiEvent.success == False
  ).order_by(ApiEvent.timestamp.desc()).first()
  ```
- Determine overall status from the MOST RECENT event (either success or failure):
  - No events at all -> "unknown"
  - Most recent is success -> "healthy"
  - Most recent is failure AND event_type is a fallback type -> "degraded"
  - Most recent is failure AND not fallback -> "offline"
- FALLBACK_TYPES: {ApiEventType.NEWS_FALLBACK, ApiEventType.EQUITY_FALLBACK, ApiEventType.EMAIL_FALLBACK}
- Return list of dicts: {api_name, display_name, status, last_success (formatted or None), last_failure (formatted or None), reason (from failure detail[:100] or None)}

Add `_get_fallback_events(db, limit=20) -> list[dict]`:
- Query ApiEvent where event_type IN (NEWS_FALLBACK, EQUITY_FALLBACK, EMAIL_FALLBACK, TOKEN_FAILED), order by timestamp DESC, limit 20
- Return list of dicts: {timestamp (formatted), api_name, event_type (human-readable label), reason (detail[:100] or None)}
- Human-readable labels: NEWS_FALLBACK="News Fallback", EQUITY_FALLBACK="Equity Fallback", EMAIL_FALLBACK="Email Fallback", TOKEN_FAILED="Token Failed"

**2. Update the dashboard route** (the function at line ~334):
- Add import for ApiEvent if not already imported (it IS imported at line 24 in MDInsights — check BrasilIntel).
- Call _get_enterprise_api_status(db) and _get_fallback_events(db) within the route handler.
- NOTE: BrasilIntel uses `Depends(get_db)` for DB sessions and `templates.TemplateResponse()` for rendering. Follow the EXISTING pattern (do NOT copy MDInsights' `SessionLocal()` / `jinja_env` pattern).
- Pass `enterprise_status` and `fallback_events` to the template context dict.

**3. Update dashboard.html:**
- Add an "Enterprise API Status" panel ABOVE the "Category Cards Row" (line 11).
- Use a Bootstrap card with card-header showing icon + "Enterprise API Status" + "Updated on each pipeline run" note.
- Inside card-body, use a 3-column row (col-md-4) — one for each API.
- Each column shows:
  - Traffic light icon (bi-check-circle-fill text-success for healthy, bi-exclamation-triangle-fill text-warning for degraded, bi-x-circle-fill text-danger for offline, bi-question-circle text-secondary for unknown)
  - Display name (strong)
  - Status badge (bg-success/warning/danger/secondary)
  - Last success timestamp: "Last success: {datetime}" or "No successful calls"
  - Last failure timestamp: "Last failure: {datetime}" or "No failures recorded"
  - Reason text (small, text-danger) if present
- Handle the empty enterprise_status list gracefully (show "No events recorded" message).

- Add a "Fallback Event Log" card BELOW the existing "Quick Actions" section (after line 136).
- Use a Bootstrap table-responsive with columns: Timestamp, API, Event Type, Reason.
- Style with `table table-sm table-striped` matching existing table patterns.
- If no fallback_events, show "No fallback events recorded" in a centered text-muted paragraph.
  </action>
  <verify>
1. Run `python -c "from app.routers.admin import router; print('Import OK')"` from C:\BrasilIntel to verify no import errors.
2. Grep for `_get_enterprise_api_status` in admin.py to confirm the helper exists.
3. Grep for `Enterprise API Status` in dashboard.html to confirm the panel was added.
4. Grep for `Fallback Event Log` in dashboard.html to confirm the fallback log was added.
5. Grep for `last_success` in admin.py to confirm separate timestamps are tracked.
  </verify>
  <done>
Dashboard route passes enterprise_status (with last_success and last_failure per API) and fallback_events to the template. Dashboard.html renders a 3-column enterprise API health panel above category cards and a fallback event log table below quick actions. Empty table states handled gracefully. All three enterprise APIs (auth, news, equity) show health status with separate success/failure timestamps.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from app.routers.admin import router"` — no import errors
2. Dashboard template contains "Enterprise API Status" panel with traffic light icons
3. Dashboard template contains "Fallback Event Log" table
4. _get_enterprise_api_status returns separate last_success and last_failure timestamps
5. Route passes enterprise_status and fallback_events to template context
</verification>

<success_criteria>
- ADMN-17 satisfied: Dashboard shows enterprise API health panel with auth status, connectivity indicator (traffic light), and timestamps of last successful AND failed requests
- Fallback event log visible on dashboard (supports ADMN-21 partially)
- No new models created — queries existing ApiEvent table
- Follows existing BrasilIntel admin patterns (Depends(get_db), templates.TemplateResponse)
</success_criteria>

<output>
After completion, create `.planning/phases/13-admin-dashboard-extensions/13-01-SUMMARY.md`
</output>
