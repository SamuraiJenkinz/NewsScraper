---
phase: 13-admin-dashboard-extensions
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routers/admin.py
  - app/templates/admin/enterprise_config.html
  - app/templates/admin/factiva.html
  - app/templates/admin/base.html
  - app/models/factiva_config.py
  - app/collectors/factiva.py
  - scripts/migrate_008_factiva_date_range.py
autonomous: true

must_haves:
  truths:
    - "Admin can enter and save MMC Core API credentials (API key, client ID, client secret) through an Enterprise Config page without editing .env files"
    - "Admin can configure Factiva query parameters (industry codes, keywords, date range) through a dedicated Factiva Config page"
    - "Date range dropdown includes 24h, 48h (default), and 7d options that affect the next pipeline run"
    - "Enterprise Config and Factiva Config appear as sidebar nav entries"
  artifacts:
    - path: "app/templates/admin/enterprise_config.html"
      provides: "Credential management form with masked secrets"
      min_lines: 100
    - path: "app/templates/admin/factiva.html"
      provides: "Factiva query config form with date range dropdown"
      min_lines: 100
    - path: "app/routers/admin.py"
      provides: "GET/POST routes for /admin/enterprise-config and /admin/factiva"
      contains: "enterprise-config"
    - path: "app/models/factiva_config.py"
      provides: "FactivaConfig model with date_range_hours column"
      contains: "date_range_hours"
    - path: "app/collectors/factiva.py"
      provides: "Collector reads date_range from query_params"
      contains: "date_range"
    - path: "app/templates/admin/base.html"
      provides: "Sidebar nav entries for Enterprise Config and Factiva Config"
      contains: "enterprise_config"
  key_links:
    - from: "app/routers/admin.py"
      to: "app/config.py"
      via: "Enterprise config reads get_settings(), writes .env, calls cache_clear()"
      pattern: "get_settings.*cache_clear"
    - from: "app/routers/admin.py"
      to: "app/models/factiva_config.py"
      via: "Factiva config reads/writes FactivaConfig row id=1"
      pattern: "FactivaConfig.*id.*1"
    - from: "app/collectors/factiva.py"
      to: "app/models/factiva_config.py"
      via: "Collector reads date_range_hours from query_params"
      pattern: "date_range"
---

<objective>
Add Enterprise Config credentials page and Factiva query config page to the BrasilIntel admin dashboard.

Purpose: Admins need to configure MMC Core API credentials and Factiva query parameters (including date range) without editing .env files or database rows directly. This satisfies ADMN-18 (credential config) and ADMN-19 (Factiva query config with date range).

Output: Two new admin pages with forms, sidebar nav entries, date_range_hours column on FactivaConfig model, and updated Factiva collector to use configurable date range.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\BrasilIntel\.planning\PROJECT.md
@C:\BrasilIntel\.planning\ROADMAP.md
@C:\BrasilIntel\.planning\STATE.md
@C:\BrasilIntel\.planning\phases\13-admin-dashboard-extensions\13-RESEARCH.md
@C:\BrasilIntel\.planning\phases\13-admin-dashboard-extensions\13-CONTEXT.md

Key existing files to read first:
@C:\BrasilIntel\app\routers\admin.py (settings page pattern at line ~978, equity page pattern)
@C:\BrasilIntel\app\templates\admin\base.html (sidebar nav entries)
@C:\BrasilIntel\app\templates\admin\settings.html (reference for credential display pattern)
@C:\BrasilIntel\app\templates\admin\equity.html (reference for form pattern)
@C:\BrasilIntel\app\config.py (Settings class with mmc_api_* fields, get_settings with @lru_cache)
@C:\BrasilIntel\app\models\factiva_config.py (current model — NO date_range column)
@C:\BrasilIntel\app\collectors\factiva.py (hardcoded timedelta(days=2) at line ~112)
@C:\BrasilIntel\scripts\migrate_007_enterprise_api_tables.py (migration pattern)

MDInsights reference (for credential save pattern):
@C:\BrasilIntel\mdinsights\app\routers\admin.py (lines 1794-1933 for enterprise_config GET/POST; lines 150-167 for _update_env_var helper)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enterprise Config credential management page</name>
  <files>app/routers/admin.py, app/templates/admin/enterprise_config.html, app/templates/admin/base.html</files>
  <action>
Read C:\BrasilIntel\app\routers\admin.py (full file), C:\BrasilIntel\app\templates\admin\base.html, C:\BrasilIntel\app\config.py, and C:\BrasilIntel\app\templates\admin\settings.html before making changes.

Also read the MDInsights enterprise config implementation for reference: C:\BrasilIntel\mdinsights\app\routers\admin.py lines 150-167 (_update_env_var helper) and lines 1794-1933 (GET/POST routes).

**IMPORTANT: BrasilIntel uses a different admin pattern than MDInsights:**
- BrasilIntel uses `templates.TemplateResponse("admin/...", {"request": request, ...})` (Starlette/FastAPI style)
- BrasilIntel uses `Depends(verify_admin)` for auth and `Depends(get_settings)` for settings
- BrasilIntel uses async route functions (not sync like MDInsights)
- Follow BrasilIntel's existing patterns, NOT MDInsights patterns

**1. Add `_update_env_var()` helper function to admin.py** (near the top, after existing helpers):
```python
def _update_env_var(env_content: str, var_name: str, value: str) -> str:
    """Replace or append an environment variable in .env file content."""
    import re
    pattern = re.compile(f"^{re.escape(var_name)}=.*$", re.MULTILINE)
    if pattern.search(env_content):
        return pattern.sub(f"{var_name}={value}", env_content)
    else:
        if env_content and not env_content.endswith("\n"):
            env_content += "\n"
        return env_content + f"{var_name}={value}\n"
```

**2. Add GET /admin/enterprise-config route:**
- Follow the existing settings_page pattern (line ~978) as the closest reference
- Read current Settings values
- Build a config_display dict with:
  - Non-secret fields: mmc_api_base_url, mmc_api_client_id, mmc_sender_email (actual values)
  - Secret fields: mmc_api_client_secret_set, mmc_api_key_set (boolean flags only, NEVER actual values)
- Render enterprise_config.html with config=config_display, active="enterprise_config"

**3. Add POST /admin/enterprise-config route:**
- Accept Form parameters for all credential fields
- Read .env file content (Path(".env"))
- Non-secret fields (mmc_api_base_url, mmc_api_client_id, mmc_sender_email): always update via _update_env_var
- Secret fields (mmc_api_client_secret, mmc_api_key): ONLY update if submitted value is non-blank (skip blank to preserve existing secrets)
- Write updated .env content
- Call `get_settings.cache_clear()` so pipeline picks up new values
- Re-render the page with success message

**4. Create app/templates/admin/enterprise_config.html:**
- Extend admin/base.html
- Title: "Enterprise Configuration"
- Page header with bi-shield-lock icon
- Success/error alert banners (dismissible)
- One card: "MMC Core API" with fields:
  - Base URL (text input, pre-populated)
  - Client ID (text input, pre-populated)
  - Client Secret (type="password", value="", placeholder shows bullets if set)
  - API Key (type="password", value="", placeholder shows bullets if set)
  - Sender Email (text input, pre-populated)
- Field hints: "Leave blank to keep existing value" for secret fields
- Save button with bi-save icon
- Follow the BrasilIntel equity.html form styling (card-based, form-control inputs)

**5. Add sidebar nav entries to base.html:**
- After the "Equity Tickers" nav item (line ~239), add TWO new entries:
  - "Factiva Config" with bi-newspaper icon (href to /admin/factiva, active check for 'factiva')
  - "Enterprise Config" with bi-shield-lock icon (href to /admin/enterprise-config, active check for 'enterprise_config')
- Place them after Equity Tickers and before the end of the nav
  </action>
  <verify>
1. Run `python -c "from app.routers.admin import router; print('Import OK')"` from C:\BrasilIntel
2. Grep for `enterprise-config` in admin.py to confirm both GET and POST routes exist
3. Verify enterprise_config.html exists and contains "MMC Core API" card
4. Grep for `enterprise_config` in base.html to confirm sidebar nav entry
5. Grep for `_update_env_var` in admin.py to confirm helper exists
6. Grep for `cache_clear` in admin.py to confirm settings cache is cleared on save
  </verify>
  <done>
Enterprise Config page at /admin/enterprise-config renders a form with MMC Core API credentials. Secret fields are masked (type=password with boolean placeholder). POST saves non-secret fields always, secret fields only when non-blank. Settings cache cleared after .env write. Sidebar nav entries added for both Enterprise Config and Factiva Config.
  </done>
</task>

<task type="auto">
  <name>Task 2: Factiva query config page with date range dropdown</name>
  <files>app/models/factiva_config.py, app/collectors/factiva.py, app/routers/admin.py, app/templates/admin/factiva.html, scripts/migrate_008_factiva_date_range.py</files>
  <action>
Read C:\BrasilIntel\app\models\factiva_config.py, C:\BrasilIntel\app\collectors\factiva.py (lines 86-134), and C:\BrasilIntel\scripts\migrate_007_enterprise_api_tables.py before making changes.

Also read the MDInsights factiva.html template for reference: C:\BrasilIntel\mdinsights\app\templates\admin\factiva.html

**1. Add date_range_hours column to FactivaConfig model:**
- Add after the `page_size` column:
```python
date_range_hours = Column(
    Integer,
    nullable=False,
    default=48,
    comment="Lookback window in hours (24, 48, or 168 for 7 days)"
)
```

**2. Create migration script scripts/migrate_008_factiva_date_range.py:**
- Follow the migrate_007 pattern exactly
- ALTER TABLE factiva_config ADD COLUMN date_range_hours INTEGER NOT NULL DEFAULT 48
- Use `try/except` to handle column already existing (idempotent)
- Verify the column exists after migration

**3. Update FactivaCollector.collect() to use date_range:**
- In C:\BrasilIntel\app\collectors\factiva.py, change the hardcoded `timedelta(days=2)` (line ~112):
- Read date_range_hours from query_params: `date_range_hours = int(query_params.get("date_range_hours", 48))`
- Replace the hardcoded date calculation:
  ```python
  # Build date window from configurable range
  today = datetime.now(timezone.utc)
  lookback = today - timedelta(hours=date_range_hours)
  from_date = lookback.strftime("%Y-%m-%d")
  to_date = today.strftime("%Y-%m-%d")
  ```
- Update the docstring from "past 48 hours" to "configured lookback window"

**4. Add GET /admin/factiva route to admin.py:**
- Query FactivaConfig row id=1 from database
- If not found, create a default row
- Render factiva.html with config=factiva_config, active="factiva"

**5. Add POST /admin/factiva route to admin.py:**
- Accept Form parameters: industry_codes, company_codes, keywords, page_size, date_range_hours, enabled
- Validate page_size (10, 25, 50, 100 — default 25)
- Validate date_range_hours (24, 48, 168 — default 48)
- Clean comma-separated inputs (strip whitespace)
- Handle enabled checkbox with hidden field pattern (submit "false" as hidden, "true" from checkbox)
- Update FactivaConfig row id=1 and commit
- Re-render with success message

NOTE: BrasilIntel needs to import FactivaConfig in admin.py if not already imported. Check the existing imports.

**6. Create app/templates/admin/factiva.html:**
- Extend admin/base.html
- Title: "Factiva Configuration"
- Page header with bi-newspaper icon and subtitle
- Success/error alert banners
- One card: "Query Parameters" with fields:
  - Industry Codes (text input, comma-separated, hint showing common codes like i82, i832)
  - Company Codes (text input, comma-separated)
  - Keywords (text input, hint: "Portuguese keywords for Brazilian insurance market")
  - Results Per Page (select dropdown: 10, 25 (default), 50, 100)
  - Date Range (select dropdown: "Last 24 hours" value=24, "Last 48 hours (default)" value=48, "Last 7 days" value=168)
  - Enable Factiva Collection (checkbox with hidden field pattern)
  - Last saved timestamp (if available)
- Save button with bi-save icon
- Reference table card below the form showing common insurance industry codes (like MDInsights factiva.html lines 181-250)
- Follow BrasilIntel equity.html form styling
  </action>
  <verify>
1. Run `python -c "from app.models.factiva_config import FactivaConfig; print(FactivaConfig.__table__.columns.keys())"` to verify date_range_hours column exists in model
2. Run `python -c "from app.routers.admin import router; print('Import OK')"` from C:\BrasilIntel
3. Grep for `date_range_hours` in factiva_config.py and factiva.py to confirm model and collector updated
4. Grep for `/admin/factiva` in admin.py to confirm routes exist
5. Verify factiva.html exists and contains date range dropdown
6. Verify migrate_008 script exists
  </verify>
  <done>
FactivaConfig model has date_range_hours column (default 48). Factiva collector reads date_range_hours from query_params instead of hardcoded timedelta. Admin page at /admin/factiva shows form with industry codes, keywords, date range dropdown (24h/48h/7d), page size, and enabled toggle. Migration script 008 adds the column to existing databases. Changes take effect on next pipeline run.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from app.routers.admin import router"` — no import errors
2. Enterprise Config page has credential form with masked secrets and .env write
3. Factiva Config page has query parameter form with date range dropdown
4. Both pages appear in sidebar navigation
5. FactivaConfig model has date_range_hours column
6. Factiva collector uses configurable date range
7. Migration script 008 exists for schema update
</verification>

<success_criteria>
- ADMN-18 satisfied: Admin can configure MMC Core API credentials via settings UI without editing .env
- ADMN-19 satisfied: Admin can configure Factiva query parameters (industry codes, keywords, date range) via dedicated page
- Date range dropdown includes 24h, 48h (default), and 7d options
- Secret fields are never rendered in HTML source
- Settings cache cleared after credential save
- Sidebar nav entries added for both pages
</success_criteria>

<output>
After completion, create `.planning/phases/13-admin-dashboard-extensions/13-02-SUMMARY.md`
</output>
