---
phase: 06-delivery-critical-alerts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/config.py
  - app/models/run.py
  - app/schemas/delivery.py
autonomous: true

must_haves:
  truths:
    - "Settings has CC/BCC fields for each category (Health, Dental, Group Life)"
    - "get_email_recipients returns EmailRecipients with to/cc/bcc lists"
    - "Run model has delivery tracking fields (email_status, email_sent_at, etc.)"
  artifacts:
    - path: "app/config.py"
      provides: "Extended Settings with CC/BCC recipient fields"
      contains: "report_recipients_health_cc"
    - path: "app/models/run.py"
      provides: "Run model with delivery tracking columns"
      contains: "email_status"
    - path: "app/schemas/delivery.py"
      provides: "EmailRecipients and DeliveryStatus schemas"
      exports: ["EmailRecipients", "DeliveryStatus"]
  key_links:
    - from: "app/config.py"
      to: "app/schemas/delivery.py"
      via: "get_email_recipients returns EmailRecipients"
      pattern: "def get_email_recipients.*EmailRecipients"
---

<objective>
Extend configuration and models for enhanced email delivery with recipient management and delivery tracking.

Purpose: Foundation for Phase 6 delivery features - CC/BCC support and delivery status tracking require schema and model changes before service implementation.

Output: Extended Settings class with CC/BCC fields per category, Run model with delivery tracking columns, EmailRecipients schema for structured recipient handling.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-delivery-critical-alerts/06-RESEARCH.md
@app/config.py
@app/models/run.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create delivery schemas</name>
  <files>app/schemas/delivery.py</files>
  <action>
Create new schema file with EmailRecipients and DeliveryStatus classes:

1. EmailRecipients (BaseModel):
   - to: list[str] - Primary recipients
   - cc: list[str] = [] - CC recipients
   - bcc: list[str] = [] - BCC recipients
   - Add validator to ensure at least one 'to' recipient when using

2. DeliveryStatus (str Enum):
   - pending - Delivery not yet attempted
   - sent - Email submitted to Graph API (202 accepted)
   - failed - Email send failed
   - skipped - No recipients configured

Use Pydantic v2 syntax (model_validator instead of root_validator).
  </action>
  <verify>python -c "from app.schemas.delivery import EmailRecipients, DeliveryStatus; print('OK')"</verify>
  <done>EmailRecipients and DeliveryStatus schemas importable and validated</done>
</task>

<task type="auto">
  <name>Task 2: Extend Settings with CC/BCC fields</name>
  <files>app/config.py</files>
  <action>
Extend Settings class with CC and BCC recipient fields for each category:

1. Add new environment variable fields after existing recipient fields:
   ```python
   report_recipients_health: str = ""  # Existing TO
   report_recipients_health_cc: str = ""  # NEW: CC
   report_recipients_health_bcc: str = ""  # NEW: BCC
   report_recipients_dental: str = ""  # Existing TO
   report_recipients_dental_cc: str = ""  # NEW
   report_recipients_dental_bcc: str = ""  # NEW
   report_recipients_group_life: str = ""  # Existing TO
   report_recipients_group_life_cc: str = ""  # NEW
   report_recipients_group_life_bcc: str = ""  # NEW
   ```

2. Add new get_email_recipients() method that returns EmailRecipients:
   ```python
   def get_email_recipients(self, category: str) -> EmailRecipients:
       """Get structured TO/CC/BCC recipients for category."""
       # Map category to field prefix
       # Parse each field using _parse_recipient_list
       # Return EmailRecipients instance
   ```

3. Add private _parse_recipient_list() helper:
   ```python
   def _parse_recipient_list(self, recipients_str: str) -> list[str]:
       """Parse comma-separated email list, stripping whitespace."""
       if not recipients_str:
           return []
       return [r.strip() for r in recipients_str.split(",") if r.strip()]
   ```

4. Keep existing get_report_recipients() for backward compatibility (returns list[str] for TO only).

Import EmailRecipients from app.schemas.delivery at top of file.
  </action>
  <verify>python -c "from app.config import get_settings; s=get_settings(); r=s.get_email_recipients('Health'); print(type(r).__name__)"</verify>
  <done>Settings has CC/BCC fields and get_email_recipients returns EmailRecipients</done>
</task>

<task type="auto">
  <name>Task 3: Extend Run model with delivery tracking</name>
  <files>app/models/run.py</files>
  <action>
Add delivery tracking columns to Run model:

1. Add new columns after error_message:
   ```python
   # Email delivery tracking (Phase 6)
   email_status = Column(String(20), nullable=True)  # pending, sent, failed, skipped
   email_sent_at = Column(DateTime, nullable=True)
   email_recipients_count = Column(Integer, default=0)
   email_error_message = Column(Text, nullable=True)

   # PDF tracking
   pdf_generated = Column(Boolean, default=False)
   pdf_size_bytes = Column(Integer, nullable=True)

   # Critical alert tracking
   critical_alert_sent = Column(Boolean, default=False)
   critical_alert_sent_at = Column(DateTime, nullable=True)
   critical_insurers_count = Column(Integer, default=0)
   ```

2. Import Boolean from sqlalchemy if not already imported.

3. Update __repr__ to include email_status if set.

Note: These are new nullable columns - SQLite will auto-migrate without explicit migration script.
  </action>
  <verify>python -c "from app.models.run import Run; print([c.name for c in Run.__table__.columns if 'email' in c.name or 'pdf' in c.name or 'critical' in c.name])"</verify>
  <done>Run model has email_status, pdf_generated, critical_alert_sent columns</done>
</task>

</tasks>

<verification>
1. All imports work:
   ```bash
   python -c "from app.schemas.delivery import EmailRecipients, DeliveryStatus"
   python -c "from app.config import get_settings; get_settings().get_email_recipients('Health')"
   python -c "from app.models.run import Run"
   ```

2. EmailRecipients validates correctly:
   ```bash
   python -c "from app.schemas.delivery import EmailRecipients; r = EmailRecipients(to=['a@b.com'], cc=['c@d.com']); print(r.model_dump())"
   ```

3. Settings parses recipients:
   ```bash
   python -c "from app.config import Settings; s = Settings(report_recipients_health='a@b.com,c@d.com'); print(s.get_email_recipients('Health').to)"
   ```
</verification>

<success_criteria>
- EmailRecipients schema exists with to/cc/bcc fields
- DeliveryStatus enum has pending/sent/failed/skipped values
- Settings.get_email_recipients() returns EmailRecipients instance
- Run model has email_status, email_sent_at, pdf_generated, critical_alert_sent columns
- Existing get_report_recipients() still works for backward compatibility
</success_criteria>

<output>
After completion, create `.planning/phases/06-delivery-critical-alerts/06-01-SUMMARY.md`
</output>
