---
phase: 01-foundation-data-layer
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - app/routers/__init__.py
  - app/routers/insurers.py
  - app/main.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin can create a new insurer via API"
    - "Admin can list all insurers with pagination"
    - "Admin can get a single insurer by ANS code"
    - "Admin can update insurer details (name, search_terms, enabled)"
    - "System rejects duplicate ANS codes with clear error"
  artifacts:
    - path: "app/routers/insurers.py"
      provides: "CRUD endpoints for insurer management"
      exports: ["router"]
    - path: "app/main.py"
      provides: "Router registration"
      contains: "include_router"
  key_links:
    - from: "app/routers/insurers.py"
      to: "app/models/insurer.py"
      via: "ORM queries"
      pattern: "db\\.query\\(Insurer\\)"
    - from: "app/routers/insurers.py"
      to: "app/schemas/insurer.py"
      via: "response_model"
      pattern: "response_model=.*InsurerResponse"
    - from: "app/main.py"
      to: "app/routers/insurers.py"
      via: "include_router"
      pattern: "app\\.include_router\\(insurers\\.router\\)"
---

<objective>
Implement insurer CRUD endpoints with search and filter capabilities.

Purpose: Enable admin to view, create, update, and search insurers - fulfilling DATA-02 (view/search/filter) and DATA-03 (edit details).

Output: Working REST API with /api/insurers endpoints for all CRUD operations.
</objective>

<execution_context>
@C:\Users\taylo\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\taylo\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\BrasilIntel\.planning\PROJECT.md
@C:\BrasilIntel\.planning\phases\01-foundation-data-layer\01-RESEARCH.md
@C:\BrasilIntel\.planning\phases\01-foundation-data-layer\01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create insurer router with list and search endpoints</name>
  <files>
    app/routers/insurers.py
  </files>
  <action>
    Create app/routers/insurers.py following research Pattern 4 (Search and Filter):

    1. Create APIRouter with prefix="/api/insurers", tags=["insurers"]

    2. Implement GET "/" - list insurers with pagination:
       - Parameters: skip: int = 0, limit: int = 100
       - Query Insurer, apply offset/limit
       - Return list with total count

    3. Implement GET "/search" - search with filters (DATA-02):
       - Parameters:
         * query: str | None = None (searches name and ans_code)
         * category: str | None = None (Health, Dental, Group Life)
         * enabled: bool | None = None
         * skip: int = 0
         * limit: int = 100
       - Build dynamic query:
         * If query provided: filter with OR on name.ilike and ans_code.contains
         * If category provided: filter exact match
         * If enabled provided: filter exact match
       - Return {"total": count, "results": items}

    4. Implement GET "/{ans_code}" - get single insurer:
       - Lookup by ans_code
       - Return 404 if not found
       - Return InsurerResponse

    Use proper imports:
    - from sqlalchemy import or_
    - from sqlalchemy.orm import Session
    - from fastapi import APIRouter, Depends, HTTPException
    - from ..dependencies import get_db
    - from ..models.insurer import Insurer
    - from ..schemas.insurer import InsurerCreate, InsurerUpdate, InsurerResponse
  </action>
  <verify>
    Import test: `python -c "from app.routers.insurers import router; print(router.prefix)"`
  </verify>
  <done>List and search endpoints created with proper filtering capabilities</done>
</task>

<task type="auto">
  <name>Task 2: Add create, update, delete endpoints with error handling</name>
  <files>
    app/routers/insurers.py
  </files>
  <action>
    Add to app/routers/insurers.py:

    1. Implement POST "/" - create insurer (DATA-01):
       - Accept InsurerCreate body
       - Create Insurer instance from validated data
       - Handle IntegrityError for duplicate ANS codes (DATA-08):
         ```python
         from sqlalchemy.exc import IntegrityError
         try:
             db.add(insurer)
             db.commit()
             db.refresh(insurer)
             return insurer
         except IntegrityError as e:
             db.rollback()
             error_msg = str(e.orig).lower()
             if 'unique' in error_msg:
                 raise HTTPException(
                     status_code=400,
                     detail=f"ANS Code {data.ans_code} already exists"
                 )
             raise HTTPException(status_code=500, detail="Database error")
         ```
       - Return 201 with created insurer

    2. Implement PATCH "/{ans_code}" - update insurer (DATA-03):
       - Accept InsurerUpdate body (partial update)
       - Lookup by ans_code, return 404 if not found
       - Only update fields that are not None:
         ```python
         update_data = data.model_dump(exclude_unset=True)
         for key, value in update_data.items():
             setattr(insurer, key, value)
         ```
       - Commit and return updated insurer

    3. Implement DELETE "/{ans_code}" - delete insurer:
       - Lookup by ans_code, return 404 if not found
       - Delete and commit
       - Return 204 No Content

    CRITICAL: Always commit in endpoint, not dependency (per research Pitfall 4)
    CRITICAL: Always rollback on IntegrityError before raising HTTPException
  </action>
  <verify>
    Syntax check: `python -c "from app.routers.insurers import router"`
  </verify>
  <done>Full CRUD endpoints with proper error handling for duplicate ANS codes</done>
</task>

<task type="auto">
  <name>Task 3: Register router and test endpoints</name>
  <files>
    app/main.py
  </files>
  <action>
    Update app/main.py:

    1. Import router: `from app.routers import insurers`
    2. Register router after app creation: `app.include_router(insurers.router)`

    Test the complete flow:

    1. Start the server
    2. Create an insurer:
       ```
       curl -X POST http://localhost:8000/api/insurers \
         -H "Content-Type: application/json" \
         -d '{"ans_code": "123456", "name": "Test Insurer", "category": "Health"}'
       ```

    3. List insurers: `curl http://localhost:8000/api/insurers`

    4. Search insurers: `curl "http://localhost:8000/api/insurers/search?query=Test&category=Health"`

    5. Get single: `curl http://localhost:8000/api/insurers/123456`

    6. Update:
       ```
       curl -X PATCH http://localhost:8000/api/insurers/123456 \
         -H "Content-Type: application/json" \
         -d '{"enabled": false}'
       ```

    7. Test duplicate rejection:
       ```
       curl -X POST http://localhost:8000/api/insurers \
         -H "Content-Type: application/json" \
         -d '{"ans_code": "123456", "name": "Duplicate", "category": "Health"}'
       ```
       Should return 400 with "ANS Code 123456 already exists"

    8. Delete: `curl -X DELETE http://localhost:8000/api/insurers/123456`
  </action>
  <verify>
    Full endpoint test sequence as described above
  </verify>
  <done>Router registered, all CRUD operations tested and working</done>
</task>

</tasks>

<verification>
1. POST /api/insurers creates new insurer and returns 201
2. GET /api/insurers returns list with pagination
3. GET /api/insurers/search?query=... filters correctly
4. GET /api/insurers/{ans_code} returns single insurer
5. PATCH /api/insurers/{ans_code} updates and returns updated record
6. DELETE /api/insurers/{ans_code} removes record
7. Duplicate ANS code returns 400 with clear message (DATA-08)
</verification>

<success_criteria>
- All CRUD endpoints accessible via /api/insurers
- Search by name and ANS code works (DATA-02)
- Filter by category works (DATA-02)
- Update name, search_terms, enabled works (DATA-03)
- Duplicate ANS code rejected with clear error message (DATA-08)
- OpenAPI docs show all endpoints with correct schemas
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-layer/01-02-SUMMARY.md`
</output>
