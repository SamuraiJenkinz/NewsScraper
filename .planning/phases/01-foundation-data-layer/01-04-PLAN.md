---
phase: 01-foundation-data-layer
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - app/services/excel_service.py
  - app/routers/import_export.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin can export current insurer data as Excel file"
    - "Exported Excel matches original import format"
    - "Export includes all insurer fields"
  artifacts:
    - path: "app/services/excel_service.py"
      provides: "Excel generation function"
      exports: ["generate_excel_export"]
    - path: "app/routers/import_export.py"
      provides: "Export endpoint"
      contains: "def export_insurers"
  key_links:
    - from: "app/routers/import_export.py"
      to: "app/services/excel_service.py"
      via: "generate_excel_export call"
      pattern: "generate_excel_export\\("
---

<objective>
Implement Excel export functionality to complete the data management cycle.

Purpose: Enable admin to export current insurer list as Excel file - fulfilling DATA-06 (export as Excel).

Output: Working export endpoint at GET /api/export that downloads Excel file.
</objective>

<execution_context>
@C:\Users\taylo\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\taylo\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\BrasilIntel\.planning\PROJECT.md
@C:\BrasilIntel\.planning\phases\01-foundation-data-layer\01-RESEARCH.md
@C:\BrasilIntel\.planning\phases\01-foundation-data-layer\01-01-SUMMARY.md
@C:\BrasilIntel\.planning\phases\01-foundation-data-layer\01-02-SUMMARY.md
@C:\BrasilIntel\.planning\phases\01-foundation-data-layer\01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Excel export service function</name>
  <files>
    app/services/excel_service.py
  </files>
  <action>
    Add to app/services/excel_service.py following research Pattern 5:

    ```python
    import io
    from typing import List
    from ..models.insurer import Insurer

    def generate_excel_export(insurers: List[Insurer]) -> io.BytesIO:
        """
        Generate Excel file from insurer list matching original import format.
        Returns BytesIO buffer ready for streaming response.
        """
        # Column mapping to match expected export format
        # Uses same names as original ByCat3.xlsx for compatibility
        data = []
        for ins in insurers:
            data.append({
                'ANS Code': ins.ans_code,
                'Insurer Name': ins.name,
                'Company Registration Number': ins.cnpj or '',
                'Product': ins.category,
                'MARKET MASTER': ins.market_master or '',
                'Status': ins.status or '',
                'Enabled': 'Yes' if ins.enabled else 'No',
                'Search Terms': ins.search_terms or ''
            })

        df = pd.DataFrame(data)

        # Write to bytes buffer
        output = io.BytesIO()
        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            df.to_excel(writer, index=False, sheet_name='Insurers')

            # Optional: Auto-adjust column widths
            worksheet = writer.sheets['Insurers']
            for idx, col in enumerate(df.columns):
                max_length = max(
                    df[col].astype(str).map(len).max(),
                    len(col)
                ) + 2
                worksheet.column_dimensions[chr(65 + idx)].width = min(max_length, 50)

        output.seek(0)
        return output
    ```
  </action>
  <verify>
    `python -c "from app.services.excel_service import generate_excel_export; print('OK')"`
  </verify>
  <done>Excel export function created with proper column mapping</done>
</task>

<task type="auto">
  <name>Task 2: Create export endpoint with optional filters</name>
  <files>
    app/routers/import_export.py
  </files>
  <action>
    Add to app/routers/import_export.py:

    ```python
    from fastapi.responses import StreamingResponse
    from datetime import datetime
    from ..services.excel_service import generate_excel_export

    @router.get("/export")
    def export_insurers(
        category: str | None = None,
        enabled: bool | None = None,
        db: Session = Depends(get_db)
    ):
        """
        Export insurers to Excel file.
        Optional filters: category, enabled status.
        """
        # Build query with optional filters
        query = db.query(Insurer)

        if category:
            query = query.filter(Insurer.category == category)
        if enabled is not None:
            query = query.filter(Insurer.enabled == enabled)

        insurers = query.order_by(Insurer.category, Insurer.name).all()

        if not insurers:
            raise HTTPException(404, "No insurers found matching criteria")

        # Generate Excel
        output = generate_excel_export(insurers)

        # Generate filename with timestamp
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"insurers_export_{timestamp}.xlsx"

        return StreamingResponse(
            output,
            media_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            headers={
                "Content-Disposition": f"attachment; filename={filename}"
            }
        )
    ```

    Also add a summary endpoint for quick stats:

    ```python
    @router.get("/stats")
    def get_import_stats(db: Session = Depends(get_db)):
        """Get summary statistics about insurers."""
        total = db.query(Insurer).count()
        enabled = db.query(Insurer).filter(Insurer.enabled == True).count()

        by_category = {}
        for category in ['Health', 'Dental', 'Group Life']:
            count = db.query(Insurer).filter(Insurer.category == category).count()
            by_category[category] = count

        return {
            'total': total,
            'enabled': enabled,
            'disabled': total - enabled,
            'by_category': by_category
        }
    ```
  </action>
  <verify>
    `python -c "from app.routers.import_export import router; print('OK')"`
  </verify>
  <done>Export endpoint created with optional filtering</done>
</task>

<task type="auto">
  <name>Task 3: Test complete import/export cycle</name>
  <files>
    (no new files - testing only)
  </files>
  <action>
    Test the complete data management cycle:

    1. Start the server if not running

    2. Import test data (use ByCat3.xlsx or create test file):
       ```
       curl -X POST http://localhost:8000/api/import/preview \
         -F "file=@refchyt/ByCat3.xlsx"
       ```

    3. Commit the import:
       ```
       curl -X POST "http://localhost:8000/api/import/commit/{session_id}"
       ```

    4. Check stats:
       ```
       curl http://localhost:8000/api/import/stats
       ```
       Should show total=897, by_category breakdown

    5. Export all insurers:
       ```
       curl -O http://localhost:8000/api/import/export
       ```
       Downloads insurers_export_TIMESTAMP.xlsx

    6. Export filtered (Health only):
       ```
       curl -O "http://localhost:8000/api/import/export?category=Health"
       ```

    7. Verify exported file:
       - Open in Excel
       - Verify column names match expected format
       - Verify row count matches stats
       - Verify data integrity (spot check a few records)

    8. Test round-trip:
       - Export current data
       - Modify a few records in Excel
       - Re-import modified file
       - Verify changes applied

    9. Verify search works with imported data:
       ```
       curl "http://localhost:8000/api/insurers/search?query=UNIMED"
       ```
       Should find UNIMED insurers
  </action>
  <verify>
    - Export downloads valid Excel file
    - Exported data matches database records
    - Round-trip import/export preserves data
    - All 897 insurers can be imported and searched
  </verify>
  <done>Complete import/export cycle verified working</done>
</task>

</tasks>

<verification>
1. GET /api/import/export downloads Excel file
2. Downloaded file opens correctly in Excel
3. Column names match original format (ANS Code, Insurer Name, etc.)
4. All insurer data present in export
5. Optional category filter works
6. Optional enabled filter works
7. GET /api/import/stats returns accurate counts
8. Round-trip import/export preserves data integrity
</verification>

<success_criteria>
- Admin can export current insurer data as Excel (DATA-06)
- Exported file format matches original import format
- Export includes all fields: ANS Code, Name, CNPJ, Category, Market Master, Status, Enabled
- Filtered export works (by category, by enabled status)
- Stats endpoint shows accurate counts per category
- Full round-trip (import -> modify -> export -> re-import) preserves data
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-layer/01-04-SUMMARY.md`
</output>
