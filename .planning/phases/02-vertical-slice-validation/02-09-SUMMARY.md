---
phase: 02-vertical-slice-validation
plan: 09
subsystem: deployment
tags: [windows, scheduled-tasks, deployment, operations, health-check]
requires: [02-07]
provides:
  - Windows Scheduled Task deployment automation
  - PowerShell management scripts for operations
  - Enhanced health check endpoint with dependency validation
affects: [operations, monitoring, deployment]
tech-stack:
  added: []
  patterns:
    - Windows Scheduled Task automation
    - PowerShell deployment scripts
    - Health check endpoint pattern
key-files:
  created:
    - deploy/setup_scheduled_task.ps1
    - deploy/manage_service.ps1
    - deploy/run_brasilintel.bat
  modified:
    - app/main.py
decisions:
  - decision: Use Windows Scheduled Task for production automation
    rationale: Native Windows solution, no additional services required, reliable scheduling
    date: 2026-02-04
  - decision: Run tasks as SYSTEM account
    rationale: Ensures proper permissions for all operations, consistent execution environment
    date: 2026-02-04
  - decision: Daily schedules staggered by category
    rationale: Health at 6 AM, Dental at 7 AM, Group Life at 8 AM prevents resource contention
    date: 2026-02-04
  - decision: Comprehensive health check with dependency validation
    rationale: Enables monitoring to detect configuration and infrastructure issues early
    date: 2026-02-04
metrics:
  duration: 20 minutes
  completed: 2026-02-04
---

# Phase 02 Plan 09: Windows Scheduled Task Deployment Summary

**One-liner**: Windows Task Scheduler deployment with PowerShell automation scripts and comprehensive health check validation for production operations.

## What Was Built

Created complete Windows deployment automation for BrasilIntel competitive intelligence runs:

### Deployment Scripts
1. **setup_scheduled_task.ps1** (196 lines)
   - Creates Windows Scheduled Tasks for automated daily runs
   - Supports health, dental, group_life categories individually or all at once
   - Validates app path, virtual environment, and .env configuration
   - Generates category-specific batch scripts
   - Configures tasks with SYSTEM account and restart on failure
   - Daily schedules: Health 06:00, Dental 07:00, Group Life 08:00

2. **manage_service.ps1** (194 lines)
   - Comprehensive service management interface
   - Commands: start, stop, status, remove, run-now, logs, test
   - Status command shows task state with color-coded display
   - Logs command displays latest log files with configurable line count
   - Test command validates health endpoint or starts development server

3. **run_brasilintel.bat** (34 lines)
   - Template batch file for scheduled task execution
   - Category-specific files generated by setup script
   - Timestamp-based log file naming
   - Virtual environment activation
   - Exit code capture and logging

### Enhanced Health Check
Updated `/api/health` endpoint with comprehensive validation:
- **Database connectivity**: Tests connection with SELECT 1 query
- **Data directory**: Verifies write permissions with test file
- **External services**: Validates Azure OpenAI, Microsoft Graph, Apify configuration
- **Status levels**: healthy, degraded (missing configs), unhealthy (critical failures)
- **Detailed response**: JSON with timestamp and per-check status

## Technical Implementation

### Scheduled Task Configuration
- **Account**: SYSTEM (highest privileges, service account)
- **Trigger**: Daily at category-specific times
- **Settings**: Start when available, restart on failure (3 attempts, 5-minute intervals)
- **Action**: Execute batch script via cmd.exe
- **Logging**: Date-stamped files in data/logs/ directory

### Management Operations
- **run-now**: Start-ScheduledTask for immediate execution
- **start**: Enable-ScheduledTask to activate scheduled runs
- **stop**: Disable-ScheduledTask to pause without removal
- **status**: Get-ScheduledTask info with last/next run times
- **logs**: Tail latest log file for each category
- **test**: Health check validation or development server startup

### Health Check Validation
```json
{
  "status": "healthy|degraded|unhealthy",
  "service": "brasilintel",
  "timestamp": "2026-02-04T17:02:27.818414",
  "checks": {
    "database": { "status": "healthy", "message": "..." },
    "data_directory": { "status": "healthy", "message": "..." },
    "external_services": {
      "azure_openai": { "status": "configured|warning", "message": "..." },
      "microsoft_graph": { "status": "configured|warning", "message": "..." },
      "apify": { "status": "configured|warning", "message": "..." }
    }
  }
}
```

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

✅ **Scripts exist**: All PowerShell and batch files created
✅ **Line counts**: setup_scheduled_task.ps1 (196), manage_service.ps1 (194), run_brasilintel.bat (34)
✅ **Health check**: Enhanced endpoint validates database, data directory, and service configuration
✅ **Key links**: setup_scheduled_task.ps1 generates category-specific batch scripts
✅ **Must-haves**: All truths and artifacts delivered

## Integration Points

### Upstream Dependencies
- **02-07**: Run orchestration endpoint provides `python -m app.main run --category` command

### Downstream Integration
- Operations team can deploy via `.\deploy\setup_scheduled_task.ps1`
- Monitoring systems can poll `/api/health` endpoint
- Log aggregation can consume data/logs/*.log files
- Service management via `.\deploy\manage_service.ps1` commands

## Operations Playbook

### Initial Deployment
```powershell
# Run as Administrator
.\deploy\setup_scheduled_task.ps1 -RunNow
```

### Daily Operations
```powershell
# Check status
.\deploy\manage_service.ps1 -Action status

# Run immediately
.\deploy\manage_service.ps1 -Action run-now -Category health

# View logs
.\deploy\manage_service.ps1 -Action logs -Category dental -LogLines 100

# Test health
.\deploy\manage_service.ps1 -Action test
```

### Troubleshooting
1. Check task status: `.\deploy\manage_service.ps1 -Action status`
2. View logs: `.\deploy\manage_service.ps1 -Action logs -Category <category>`
3. Test health: `curl http://localhost:8000/api/health`
4. Run manually: `.\deploy\manage_service.ps1 -Action run-now -Category <category>`

## Files Modified

### Created
- `deploy/setup_scheduled_task.ps1`: Scheduled task setup automation
- `deploy/manage_service.ps1`: Service management commands
- `deploy/run_brasilintel.bat`: Batch execution template

### Modified
- `app/main.py`: Enhanced health check endpoint with dependency validation

## Success Metrics

- ✅ 4/4 tasks completed
- ✅ 4 atomic commits created
- ✅ All verification checks passed
- ✅ Zero deviations from plan
- ✅ Production-ready deployment scripts

## Next Phase Readiness

**Ready for production deployment**: Scripts validated and tested.

### Recommended Next Steps
1. Deploy to Windows Server environment
2. Configure .env with production credentials
3. Set up monitoring alerts on health endpoint
4. Configure log rotation for data/logs/ directory

### Outstanding Considerations
- Log rotation strategy for long-running deployments
- Monitoring integration for task execution failures
- Alert configuration for health check degraded/unhealthy states
- Backup strategy for SQLite database file

## Lessons Learned

### What Went Well
- PowerShell automation provides clean Windows-native deployment
- Comprehensive health check catches configuration issues early
- Management script covers all operational scenarios
- Staggered schedules prevent resource contention

### What Could Be Improved
- Consider Windows Service alternative for always-running scenarios
- Add email notification on task failure
- Implement log rotation in setup script
- Add database backup scheduling

## Wave 4 Context

This plan completes Wave 4 (Production Readiness) by delivering Windows deployment automation. Combined with previous waves:
- **Wave 1**: Data models and API foundation
- **Wave 2**: Scraping and intelligence pipeline
- **Wave 3**: Orchestration and reporting
- **Wave 4**: Production deployment automation ✅

System is now ready for Windows Server deployment with comprehensive operational tooling.
