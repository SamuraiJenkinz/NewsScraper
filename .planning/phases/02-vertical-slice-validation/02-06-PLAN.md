---
phase: 02-vertical-slice-validation
plan: 06
type: execute
wave: 3
depends_on: [02-01, 02-04]
files_modified:
  - app/services/reporter.py
  - app/templates/report_basic.html
autonomous: true

must_haves:
  truths:
    - "HTML report generated using Jinja2 templates"
    - "Report groups insurers by status priority (Critical first)"
    - "Report includes executive summary with status counts"
  artifacts:
    - path: "app/services/reporter.py"
      provides: "ReportService for generating HTML reports"
      exports: ["ReportService"]
      min_lines: 60
    - path: "app/templates/report_basic.html"
      provides: "Jinja2 template for basic HTML report"
      min_lines: 80
  key_links:
    - from: "app/services/reporter.py"
      to: "app/templates/report_basic.html"
      via: "Jinja2 template loading"
      pattern: "get_template.*report_basic"
---

<objective>
Create HTML report generator using Jinja2 templates.

Purpose: Transforms classified insurer news into professional HTML reports suitable for email delivery. Basic template establishes structure for later Marsh branding.

Output: ReportService that generates HTML reports with executive summary and status-grouped insurers.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-vertical-slice-validation/02-RESEARCH.md

# Dependencies
@app/config.py
@app/schemas/news.py
@app/schemas/classification.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create templates directory and basic report template</name>
  <files>app/templates/report_basic.html</files>
  <action>
Create app/templates directory and basic HTML report template:

```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ company_name }} - {{ category }} Intelligence Report</title>
    <style>
        /* Reset and base styles */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #003366 0%, #004080 100%);
            color: white;
            padding: 30px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
        }
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        .header .confidential {
            font-size: 12px;
            margin-top: 15px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.2);
            display: inline-block;
            border-radius: 4px;
        }

        /* Main content */
        .content {
            background: white;
            padding: 30px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Executive Summary */
        .executive-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 30px;
            border-left: 4px solid #003366;
        }
        .executive-summary h2 {
            font-size: 18px;
            color: #003366;
            margin-bottom: 15px;
        }
        .summary-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-card.critical { background: #fff5f5; border: 1px solid #dc3545; }
        .stat-card.watch { background: #fff8f0; border: 1px solid #fd7e14; }
        .stat-card.monitor { background: #fffbeb; border: 1px solid #ffc107; }
        .stat-card.stable { background: #f0fff4; border: 1px solid #28a745; }
        .stat-number {
            font-size: 28px;
            font-weight: bold;
        }
        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-card.critical .stat-number { color: #dc3545; }
        .stat-card.watch .stat-number { color: #fd7e14; }
        .stat-card.monitor .stat-number { color: #ffc107; }
        .stat-card.stable .stat-number { color: #28a745; }

        /* Status sections */
        .status-section {
            margin-bottom: 30px;
        }
        .status-section h3 {
            font-size: 16px;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .status-section.critical h3 { background: #dc3545; color: white; }
        .status-section.watch h3 { background: #fd7e14; color: white; }
        .status-section.monitor h3 { background: #ffc107; color: #333; }
        .status-section.stable h3 { background: #28a745; color: white; }

        /* Insurer cards */
        .insurer-card {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 15px;
            background: white;
        }
        .insurer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .insurer-name {
            font-size: 16px;
            font-weight: bold;
            color: #003366;
        }
        .insurer-code {
            font-size: 12px;
            color: #666;
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 4px;
        }

        /* News items */
        .news-item {
            padding: 15px;
            margin-bottom: 10px;
            border-left: 3px solid #ccc;
            background: #fafafa;
            border-radius: 0 4px 4px 0;
        }
        .news-title {
            font-weight: bold;
            margin-bottom: 8px;
        }
        .news-title a {
            color: #003366;
            text-decoration: none;
        }
        .news-title a:hover {
            text-decoration: underline;
        }
        .news-summary {
            padding-left: 15px;
            margin-bottom: 10px;
        }
        .news-summary li {
            margin-bottom: 5px;
            color: #555;
        }
        .news-meta {
            font-size: 12px;
            color: #888;
        }
        .news-sentiment {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 10px;
        }
        .news-sentiment.positive { background: #d4edda; color: #155724; }
        .news-sentiment.negative { background: #f8d7da; color: #721c24; }
        .news-sentiment.neutral { background: #e2e3e5; color: #383d41; }

        /* Footer */
        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            font-size: 12px;
            color: #888;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 600px) {
            body { padding: 10px; }
            .header { padding: 20px; }
            .header h1 { font-size: 20px; }
            .content { padding: 15px; }
            .summary-stats { flex-direction: column; }
            .stat-card { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{ company_name }}</h1>
        <div class="subtitle">{{ category }} Intelligence Report - {{ report_date }}</div>
        <div class="confidential">CONFIDENCIAL</div>
    </div>

    <div class="content">
        <div class="executive-summary">
            <h2>Resumo Executivo</h2>
            <p>Este relatório abrange <strong>{{ total_insurers }}</strong> seguradoras na categoria {{ category }}.</p>

            <div class="summary-stats">
                <div class="stat-card critical">
                    <div class="stat-number">{{ critical_count }}</div>
                    <div class="stat-label">Critical</div>
                </div>
                <div class="stat-card watch">
                    <div class="stat-number">{{ watch_count }}</div>
                    <div class="stat-label">Watch</div>
                </div>
                <div class="stat-card monitor">
                    <div class="stat-number">{{ monitor_count }}</div>
                    <div class="stat-label">Monitor</div>
                </div>
                <div class="stat-card stable">
                    <div class="stat-number">{{ stable_count }}</div>
                    <div class="stat-label">Stable</div>
                </div>
            </div>
        </div>

        {% for status in ['Critical', 'Watch', 'Monitor', 'Stable'] %}
        {% set status_insurers = insurers_by_status.get(status, []) %}
        {% if status_insurers %}
        <div class="status-section {{ status|lower }}">
            <h3>{{ status }} ({{ status_insurers|length }})</h3>

            {% for insurer in status_insurers %}
            <div class="insurer-card">
                <div class="insurer-header">
                    <span class="insurer-name">{{ insurer.name }}</span>
                    <span class="insurer-code">ANS: {{ insurer.ans_code }}</span>
                </div>

                {% for item in insurer.news_items %}
                <div class="news-item">
                    <div class="news-title">
                        {% if item.url %}
                        <a href="{{ item.url }}" target="_blank">{{ item.title }}</a>
                        {% else %}
                        {{ item.title }}
                        {% endif %}
                    </div>

                    {% if item.summary_bullets %}
                    <ul class="news-summary">
                        {% for bullet in item.summary_bullets %}
                        <li>{{ bullet }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}

                    <div class="news-meta">
                        {% if item.source %}Fonte: {{ item.source }}{% endif %}
                        {% if item.published_at %} | {{ item.published_at }}{% endif %}
                        {% if item.sentiment %}
                        <span class="news-sentiment {{ item.sentiment }}">{{ item.sentiment }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <div class="footer">
        <p>Gerado em: {{ generated_at }} | BrasilIntel v0.1.0</p>
        <p>Este relatório é confidencial e destinado apenas aos destinatários indicados.</p>
    </div>
</body>
</html>
```
  </action>
  <verify>File exists at app/templates/report_basic.html</verify>
  <done>Basic HTML report template created with responsive design and status-based styling</done>
</task>

<task type="auto">
  <name>Task 2: Create ReportService class</name>
  <files>app/services/reporter.py</files>
  <action>
Create report generation service:

```python
# app/services/reporter.py
"""
HTML report generation service using Jinja2 templates.

Transforms classified insurer news data into professional HTML reports
suitable for email delivery.
"""
import logging
from datetime import datetime
from pathlib import Path
from typing import Any

from jinja2 import Environment, FileSystemLoader, select_autoescape

from app.config import get_settings

logger = logging.getLogger(__name__)


# Define template directory relative to this file
TEMPLATES_DIR = Path(__file__).parent.parent / "templates"


class ReportData:
    """Data container for report generation."""

    def __init__(
        self,
        category: str,
        insurers: list[dict[str, Any]],
        report_date: str | None = None,
    ):
        """
        Initialize report data.

        Args:
            category: Report category (Health, Dental, Group Life)
            insurers: List of insurer dicts with news_items
            report_date: Optional date string, defaults to today
        """
        self.category = category
        self.insurers = insurers
        self.report_date = report_date or datetime.now().strftime("%Y-%m-%d")

    def get_insurers_by_status(self) -> dict[str, list[dict]]:
        """Group insurers by their status."""
        grouped: dict[str, list[dict]] = {
            "Critical": [],
            "Watch": [],
            "Monitor": [],
            "Stable": [],
        }

        for insurer in self.insurers:
            status = insurer.get("status", "Monitor")
            if status in grouped:
                grouped[status].append(insurer)
            else:
                grouped["Monitor"].append(insurer)

        return grouped

    def get_status_counts(self) -> dict[str, int]:
        """Get count of insurers per status."""
        grouped = self.get_insurers_by_status()
        return {status: len(insurers) for status, insurers in grouped.items()}


class ReportService:
    """
    Service for generating HTML reports using Jinja2 templates.

    Supports multiple template types and automatic status grouping.
    """

    def __init__(self):
        settings = get_settings()
        self.company_name = settings.company_name

        # Initialize Jinja2 environment
        self.env = Environment(
            loader=FileSystemLoader(TEMPLATES_DIR),
            autoescape=select_autoescape(["html", "xml"]),
        )

    def generate_report(
        self,
        category: str,
        insurers: list[dict[str, Any]],
        report_date: str | None = None,
        template_name: str = "report_basic.html",
    ) -> str:
        """
        Generate HTML report for a category.

        Args:
            category: Report category (Health, Dental, Group Life)
            insurers: List of insurer dicts with news_items
            report_date: Optional date string
            template_name: Jinja2 template filename

        Returns:
            Rendered HTML string
        """
        data = ReportData(category, insurers, report_date)
        counts = data.get_status_counts()

        context = {
            "company_name": self.company_name,
            "category": category,
            "report_date": data.report_date,
            "total_insurers": len(insurers),
            "critical_count": counts["Critical"],
            "watch_count": counts["Watch"],
            "monitor_count": counts["Monitor"],
            "stable_count": counts["Stable"],
            "insurers_by_status": data.get_insurers_by_status(),
            "generated_at": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        }

        try:
            template = self.env.get_template(template_name)
            return template.render(**context)
        except Exception as e:
            logger.error(f"Failed to render report template: {e}")
            raise

    def generate_report_from_db(
        self,
        category: str,
        run_id: int,
        db_session: Any,
    ) -> str:
        """
        Generate report from database records for a specific run.

        Args:
            category: Report category
            run_id: Run ID to get news items from
            db_session: SQLAlchemy session

        Returns:
            Rendered HTML string
        """
        from app.models.news_item import NewsItem
        from app.models.insurer import Insurer

        # Query news items for this run with insurer info
        news_items = (
            db_session.query(NewsItem)
            .filter(NewsItem.run_id == run_id)
            .join(Insurer)
            .all()
        )

        # Group by insurer
        insurers_map: dict[int, dict] = {}
        for item in news_items:
            insurer_id = item.insurer_id
            if insurer_id not in insurers_map:
                insurers_map[insurer_id] = {
                    "id": item.insurer.id,
                    "name": item.insurer.name,
                    "ans_code": item.insurer.ans_code,
                    "status": item.status or "Monitor",
                    "news_items": [],
                }

            # Parse summary bullets from stored summary
            summary_bullets = []
            if item.summary:
                # Summary stored as newline-separated bullets
                summary_bullets = [
                    b.strip().lstrip("- ")
                    for b in item.summary.split("\n")
                    if b.strip()
                ]

            insurers_map[insurer_id]["news_items"].append({
                "title": item.title,
                "url": item.source_url,
                "source": item.source_name,
                "published_at": (
                    item.published_at.strftime("%Y-%m-%d")
                    if item.published_at
                    else None
                ),
                "sentiment": item.sentiment,
                "summary_bullets": summary_bullets,
            })

            # Use highest severity status from any news item
            if item.status:
                current = insurers_map[insurer_id]["status"]
                severity_order = ["Critical", "Watch", "Monitor", "Stable"]
                if severity_order.index(item.status) < severity_order.index(current):
                    insurers_map[insurer_id]["status"] = item.status

        insurers = list(insurers_map.values())
        return self.generate_report(category, insurers)

    def preview_template(self) -> str:
        """
        Generate a preview report with sample data.

        Useful for testing template rendering without real data.
        """
        sample_insurers = [
            {
                "name": "Seguradora Exemplo S.A.",
                "ans_code": "123456",
                "status": "Critical",
                "news_items": [
                    {
                        "title": "Seguradora enfrenta crise financeira",
                        "url": "https://example.com/news/1",
                        "source": "Valor Econômico",
                        "published_at": "2026-02-04",
                        "sentiment": "negative",
                        "summary_bullets": [
                            "Empresa reportou prejuízo de R$ 500 milhões",
                            "ANS monitora situação financeira",
                            "Diretoria promete plano de recuperação",
                        ],
                    }
                ],
            },
            {
                "name": "Plano Saúde Brasil",
                "ans_code": "789012",
                "status": "Stable",
                "news_items": [
                    {
                        "title": "Plano expande rede de atendimento",
                        "url": "https://example.com/news/2",
                        "source": "InfoMoney",
                        "published_at": "2026-02-03",
                        "sentiment": "positive",
                        "summary_bullets": [
                            "30 novos hospitais credenciados",
                            "Expansão para região Norte",
                        ],
                    }
                ],
            },
        ]

        return self.generate_report("Health", sample_insurers, "2026-02-04")
```
  </action>
  <verify>python -c "from app.services.reporter import ReportService; s = ReportService(); html = s.preview_template(); print(f'Generated {len(html)} chars')"</verify>
  <done>ReportService created with generate_report, generate_report_from_db, and preview_template methods</done>
</task>

<task type="auto">
  <name>Task 3: Update services __init__.py</name>
  <files>app/services/__init__.py</files>
  <action>
Export the report service:

```python
# app/services/__init__.py
from app.services.excel_service import parse_excel_upload, generate_excel_export
from app.services.scraper import ApifyScraperService
from app.services.classifier import ClassificationService
from app.services.emailer import GraphEmailService
from app.services.reporter import ReportService
```
  </action>
  <verify>python -c "from app.services import ReportService; print('Export OK')"</verify>
  <done>ReportService exported from services package</done>
</task>

</tasks>

<verification>
1. Template exists: `ls app/templates/report_basic.html`
2. Service imports: `python -c "from app.services.reporter import ReportService, ReportData"`
3. Preview works: `python -c "from app.services.reporter import ReportService; s = ReportService(); print(len(s.preview_template()))"`
4. Status grouping: Preview template shows Critical section before Stable
</verification>

<success_criteria>
- report_basic.html template renders with status colors, responsive layout, and Portuguese labels
- ReportService uses Jinja2 Environment with file loader
- generate_report() accepts category, insurers list, and optional date
- Insurers grouped by status with Critical first, then Watch, Monitor, Stable
- Executive summary shows status counts
- preview_template() generates sample report for testing
</success_criteria>

<output>
After completion, create `.planning/phases/02-vertical-slice-validation/02-06-SUMMARY.md`
</output>
