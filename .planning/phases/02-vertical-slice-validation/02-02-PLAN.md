---
phase: 02-vertical-slice-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/config.py
  - .env.example
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "Application loads configuration from environment variables via pydantic-settings"
    - "Settings singleton available throughout application"
    - "Missing required config raises validation error at startup"
  artifacts:
    - path: "app/config.py"
      provides: "Settings class with all external service configuration"
      exports: ["Settings", "get_settings"]
      min_lines: 40
    - path: ".env.example"
      provides: "Template for all required environment variables"
      min_lines: 25
  key_links:
    - from: "app/config.py"
      to: ".env"
      via: "pydantic-settings env_file loading"
      pattern: 'env_file.*=.*".env"'
---

<objective>
Create centralized configuration module using pydantic-settings for all external service credentials.

Purpose: Single source of truth for Azure OpenAI, Microsoft Graph, Apify, and application settings. Enables validation at startup and clean dependency injection.

Output: Settings class that loads from .env file with validation for required fields.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-vertical-slice-validation/02-RESEARCH.md

# Existing patterns
@app/main.py
@requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pydantic-settings to requirements.txt</name>
  <files>requirements.txt</files>
  <action>
Add pydantic-settings and other Phase 2 dependencies to requirements.txt:

```
# Phase 2 - Vertical Slice
pydantic-settings>=2.0.0

# Web scraping
apify-client>=1.8.0

# Azure OpenAI
openai>=1.42.0
azure-identity>=1.15.0

# Microsoft Graph email
msgraph-sdk>=1.0.0

# Report templates
jinja2>=3.1.0

# Structured logging
structlog>=24.0.0

# HTTP client (for service health checks)
httpx>=0.27.0
```

Run `pip install -r requirements.txt` after updating.
  </action>
  <verify>pip install -r requirements.txt succeeds without errors</verify>
  <done>All Phase 2 dependencies installed and importable</done>
</task>

<task type="auto">
  <name>Task 2: Create Settings class with pydantic-settings</name>
  <files>app/config.py</files>
  <action>
Create configuration module following research pattern:

```python
# app/config.py
"""
Application configuration loaded from environment variables.

Uses pydantic-settings for validation and .env file loading.
All external service credentials centralized here.
"""
from functools import lru_cache
from typing import Optional
from pydantic_settings import BaseSettings, SettingsConfigDict


class Settings(BaseSettings):
    """Application configuration loaded from environment."""

    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        case_sensitive=False,
        extra="ignore"  # Allow extra env vars without error
    )

    # Database
    database_url: str = "sqlite:///./data/brasilintel.db"
    data_dir: str = "./data"

    # Azure OpenAI
    azure_openai_endpoint: str = ""
    azure_openai_api_key: str = ""
    azure_openai_deployment: str = "gpt-4o"
    azure_openai_api_version: str = "2024-08-01-preview"
    use_llm_summary: bool = True

    # Microsoft Graph (for email)
    azure_tenant_id: str = ""
    azure_client_id: str = ""
    azure_client_secret: str = ""
    sender_email: str = ""

    # Apify (for web scraping)
    apify_token: str = ""

    # Application
    debug: bool = False
    log_level: str = "INFO"
    host: str = "0.0.0.0"
    port: int = 8000

    # Report settings
    company_name: str = "Marsh Brasil"
    report_recipients_health: str = ""  # Comma-separated emails
    report_recipients_dental: str = ""
    report_recipients_group_life: str = ""

    def get_report_recipients(self, category: str) -> list[str]:
        """Get list of recipients for a category."""
        recipients_map = {
            "Health": self.report_recipients_health,
            "Dental": self.report_recipients_dental,
            "Group Life": self.report_recipients_group_life,
        }
        recipients_str = recipients_map.get(category, "")
        if not recipients_str:
            return []
        return [r.strip() for r in recipients_str.split(",") if r.strip()]

    def is_azure_openai_configured(self) -> bool:
        """Check if Azure OpenAI is fully configured."""
        return bool(
            self.azure_openai_endpoint
            and self.azure_openai_api_key
            and self.azure_openai_deployment
        )

    def is_graph_configured(self) -> bool:
        """Check if Microsoft Graph email is fully configured."""
        return bool(
            self.azure_tenant_id
            and self.azure_client_id
            and self.azure_client_secret
            and self.sender_email
        )

    def is_apify_configured(self) -> bool:
        """Check if Apify is configured."""
        return bool(self.apify_token)


@lru_cache()
def get_settings() -> Settings:
    """
    Get cached settings instance.

    Uses lru_cache to ensure only one Settings object is created.
    """
    return Settings()
```
  </action>
  <verify>python -c "from app.config import get_settings; s = get_settings(); print(f'Settings loaded, debug={s.debug}')"</verify>
  <done>Settings class loads from .env with validation and helper methods for service availability</done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive .env.example</name>
  <files>.env.example</files>
  <action>
Create .env.example with all required variables for Phase 2:

```bash
# BrasilIntel Configuration
# Copy this file to .env and fill in your values

# ============================================
# Database Configuration
# ============================================
DATABASE_URL=sqlite:///./data/brasilintel.db
DATA_DIR=./data

# ============================================
# Azure OpenAI Configuration
# ============================================
# Your Azure OpenAI endpoint (e.g., https://your-resource.openai.azure.com)
AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com

# Your Azure OpenAI API key
AZURE_OPENAI_API_KEY=your-api-key-here

# Deployment name for chat model (e.g., gpt-4o, gpt-4o-mini)
AZURE_OPENAI_DEPLOYMENT=gpt-4o

# API version (use 2024-08-01-preview for structured outputs)
AZURE_OPENAI_API_VERSION=2024-08-01-preview

# Enable/disable LLM summarization (true/false)
USE_LLM_SUMMARY=true

# ============================================
# Microsoft Graph Configuration (for email)
# ============================================
# Azure AD Tenant ID (Directory ID)
AZURE_TENANT_ID=your-tenant-id-here

# Application (Client) ID from Azure AD app registration
AZURE_CLIENT_ID=your-client-id-here

# Client Secret from Azure AD app registration
AZURE_CLIENT_SECRET=your-client-secret-here

# Email address to send reports from (must have Mail.Send permission)
SENDER_EMAIL=reports@yourcompany.com

# ============================================
# Apify Configuration (for web scraping)
# ============================================
# Your Apify API token from https://console.apify.com/settings/integrations
APIFY_TOKEN=your-apify-token-here

# ============================================
# Report Recipients (comma-separated emails)
# ============================================
REPORT_RECIPIENTS_HEALTH=manager@company.com,team@company.com
REPORT_RECIPIENTS_DENTAL=dental-team@company.com
REPORT_RECIPIENTS_GROUP_LIFE=life-team@company.com

# ============================================
# Application Settings
# ============================================
# Company name for report headers
COMPANY_NAME=Marsh Brasil

# Debug mode (enables verbose logging)
DEBUG=false

# Log level (DEBUG, INFO, WARNING, ERROR)
LOG_LEVEL=INFO

# Server host and port
HOST=0.0.0.0
PORT=8000
```
  </action>
  <verify>File exists and contains all required variable names</verify>
  <done>.env.example documents all Phase 2 configuration with helpful comments</done>
</task>

</tasks>

<verification>
1. Dependencies install: `pip install -r requirements.txt`
2. Config loads: `python -c "from app.config import get_settings; print(get_settings().company_name)"`
3. Validation works: Settings class rejects invalid types
4. Helper methods work: is_azure_openai_configured(), is_graph_configured(), is_apify_configured()
</verification>

<success_criteria>
- pydantic-settings and all Phase 2 deps in requirements.txt and installed
- Settings class loads from .env file automatically
- get_settings() returns cached singleton
- Helper methods correctly detect configured services
- .env.example documents all variables with descriptions
</success_criteria>

<output>
After completion, create `.planning/phases/02-vertical-slice-validation/02-02-SUMMARY.md`
</output>
