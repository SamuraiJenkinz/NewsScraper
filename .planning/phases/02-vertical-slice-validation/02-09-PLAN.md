---
phase: 02-vertical-slice-validation
plan: 09
type: execute
wave: 4
depends_on: [02-07]
files_modified:
  - deploy/setup_scheduled_task.ps1
  - deploy/manage_service.ps1
  - deploy/run_brasilintel.bat
  - app/main.py
autonomous: true
user_setup:
  - service: windows_scheduled_task
    why: "Production deployment on Windows Server"
    env_vars: []
    dashboard_config:
      - task: "Copy application to C:\\BrasilIntel"
        location: "Windows Server filesystem"
      - task: "Create virtual environment and install dependencies"
        location: "PowerShell: python -m venv venv && venv\\Scripts\\pip install -r requirements.txt"
      - task: "Copy .env file with production credentials"
        location: "C:\\BrasilIntel\\.env"
      - task: "Run setup script as Administrator"
        location: "PowerShell: .\\deploy\\setup_scheduled_task.ps1"

must_haves:
  truths:
    - "PowerShell setup script creates Windows Scheduled Task"
    - "Management script supports start/stop/status/logs/run-now commands"
    - "Health check endpoint validates all service dependencies"
  artifacts:
    - path: "deploy/setup_scheduled_task.ps1"
      provides: "Scheduled task creation script"
      min_lines: 80
    - path: "deploy/manage_service.ps1"
      provides: "Service management script"
      min_lines: 60
    - path: "deploy/run_brasilintel.bat"
      provides: "Batch file for scheduled task execution"
      min_lines: 15
  key_links:
    - from: "deploy/setup_scheduled_task.ps1"
      to: "deploy/run_brasilintel.bat"
      via: "Creates batch script"
      pattern: "run_brasilintel.bat"
    - from: "deploy/run_brasilintel.bat"
      to: "app/main.py"
      via: "python -m app.main"
      pattern: "python.*app.main"
---

<objective>
Create Windows Scheduled Task deployment scripts and enhance health check endpoint.

Purpose: Enables production deployment on Windows Server via Windows Task Scheduler with comprehensive management scripts for operations.

Output: PowerShell scripts for deployment and management, enhanced health check.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-vertical-slice-validation/02-RESEARCH.md

# Reference scripts
@refchyt/deploy/setup_scheduled_task.ps1
@refchyt/deploy/manage_service.ps1

# Application entry
@app/main.py
@app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deploy directory and setup script</name>
  <files>deploy/setup_scheduled_task.ps1</files>
  <action>
Create deploy/setup_scheduled_task.ps1 based on reference pattern:

```powershell
# BrasilIntel - Scheduled Task Setup Script
# Run as Administrator on Windows Server
# Creates daily scheduled tasks for each product category

param(
    [string]$AppPath = "C:\BrasilIntel",
    [string]$TaskNamePrefix = "BrasilIntel",
    [ValidateSet("health", "dental", "group_life", "all")]
    [string]$Category = "all",
    [switch]$RunNow
)

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "BrasilIntel - Scheduled Task Setup" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

# Check for admin rights
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
if (-not $isAdmin) {
    Write-Host "ERROR: Run this script as Administrator" -ForegroundColor Red
    exit 1
}

# Verify app path exists
if (-not (Test-Path "$AppPath\app\main.py")) {
    Write-Host "ERROR: app\main.py not found at $AppPath" -ForegroundColor Red
    Write-Host "Ensure the BrasilIntel project is deployed to $AppPath" -ForegroundColor Yellow
    exit 1
}

# Verify venv exists
if (-not (Test-Path "$AppPath\venv\Scripts\python.exe")) {
    Write-Host "ERROR: Virtual environment not found at $AppPath\venv" -ForegroundColor Red
    Write-Host "Create venv first:" -ForegroundColor Yellow
    Write-Host "  cd $AppPath" -ForegroundColor White
    Write-Host "  python -m venv venv" -ForegroundColor White
    Write-Host "  venv\Scripts\pip install -r requirements.txt" -ForegroundColor White
    exit 1
}

# Verify .env exists
if (-not (Test-Path "$AppPath\.env")) {
    Write-Host "ERROR: .env file not found at $AppPath" -ForegroundColor Red
    Write-Host "Copy .env.example to .env and configure:" -ForegroundColor Yellow
    Write-Host "  - Azure OpenAI credentials" -ForegroundColor White
    Write-Host "  - Microsoft Graph credentials" -ForegroundColor White
    Write-Host "  - Apify token" -ForegroundColor White
    exit 1
}

Write-Host "Configuration:" -ForegroundColor Green
Write-Host "  App Path:    $AppPath"
Write-Host "  Task Prefix: $TaskNamePrefix"
Write-Host "  Category:    $Category"
Write-Host ""

# Create logs directory
$logsPath = "$AppPath\data\logs"
if (-not (Test-Path $logsPath)) {
    New-Item -ItemType Directory -Path $logsPath -Force | Out-Null
    Write-Host "Created logs directory: $logsPath" -ForegroundColor Green
}

# Define schedule times (Sao Paulo time)
$schedules = @{
    "health" = @{ Time = "06:00"; Category = "Health" }
    "dental" = @{ Time = "07:00"; Category = "Dental" }
    "group_life" = @{ Time = "08:00"; Category = "Group Life" }
}

# Categories to create
$categoriesToCreate = if ($Category -eq "all") {
    $schedules.Keys
} else {
    @($Category)
}

foreach ($cat in $categoriesToCreate) {
    $schedule = $schedules[$cat]
    $taskName = "$TaskNamePrefix-$cat"
    $categoryName = $schedule.Category

    Write-Host "Setting up task: $taskName" -ForegroundColor Cyan

    # Create batch script for this category
    $batchScript = @"
@echo off
cd /d $AppPath

REM Generate timestamp for log file
for /f "tokens=2 delims==" %%I in ('wmic os get localdatetime /value') do set datetime=%%I
set LOGFILE=$AppPath\data\logs\run_$($cat)_%datetime:~0,8%_%datetime:~8,6%.log

echo ======================================== >> "%LOGFILE%"
echo BrasilIntel - $categoryName Report Run >> "%LOGFILE%"
echo %date% %time% >> "%LOGFILE%"
echo ======================================== >> "%LOGFILE%"

call venv\Scripts\activate.bat
python -m app.main run --category "$categoryName" >> "%LOGFILE%" 2>&1
set EXITCODE=%ERRORLEVEL%

echo ======================================== >> "%LOGFILE%"
echo Completed: %date% %time% >> "%LOGFILE%"
echo Exit Code: %EXITCODE% >> "%LOGFILE%"
echo ======================================== >> "%LOGFILE%"

exit /b %EXITCODE%
"@

    $batchPath = "$AppPath\deploy\run_$cat.bat"
    Set-Content -Path $batchPath -Value $batchScript -Force
    Write-Host "  Created batch script: $batchPath" -ForegroundColor Green

    # Remove existing task if present
    $existingTask = Get-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue
    if ($existingTask) {
        Write-Host "  Removing existing task..." -ForegroundColor Yellow
        Unregister-ScheduledTask -TaskName $taskName -Confirm:$false
    }

    # Create scheduled task action
    $action = New-ScheduledTaskAction `
        -Execute "cmd.exe" `
        -Argument "/c `"$batchPath`"" `
        -WorkingDirectory $AppPath

    # Create daily trigger at specified time
    $trigger = New-ScheduledTaskTrigger -Daily -At $schedule.Time

    # Run as SYSTEM account
    $principal = New-ScheduledTaskPrincipal `
        -UserId "SYSTEM" `
        -LogonType ServiceAccount `
        -RunLevel Highest

    # Task settings
    $settings = New-ScheduledTaskSettingsSet `
        -AllowStartIfOnBatteries `
        -DontStopIfGoingOnBatteries `
        -StartWhenAvailable `
        -RestartInterval (New-TimeSpan -Minutes 5) `
        -RestartCount 3 `
        -ExecutionTimeLimit (New-TimeSpan -Hours 2) `
        -MultipleInstances IgnoreNew

    # Register the task
    Register-ScheduledTask `
        -TaskName $taskName `
        -Action $action `
        -Trigger $trigger `
        -Principal $principal `
        -Settings $settings `
        -Description "BrasilIntel $categoryName intelligence report - Daily at $($schedule.Time)" | Out-Null

    Write-Host "  Created task: $taskName (runs daily at $($schedule.Time))" -ForegroundColor Green
}

Write-Host ""
Write-Host "========================================" -ForegroundColor Green
Write-Host "SUCCESS! Scheduled tasks configured" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Green
Write-Host ""
Write-Host "Tasks created:" -ForegroundColor Cyan
foreach ($cat in $categoriesToCreate) {
    $schedule = $schedules[$cat]
    Write-Host "  - $TaskNamePrefix-$cat at $($schedule.Time)"
}
Write-Host ""
Write-Host "Management commands:" -ForegroundColor Cyan
Write-Host "  Status:   .\deploy\manage_service.ps1 -Action status"
Write-Host "  Run now:  .\deploy\manage_service.ps1 -Action run-now -Category health"
Write-Host "  Logs:     .\deploy\manage_service.ps1 -Action logs"
Write-Host ""

if ($RunNow) {
    Write-Host "Running tasks now..." -ForegroundColor Cyan
    foreach ($cat in $categoriesToCreate) {
        Start-ScheduledTask -TaskName "$TaskNamePrefix-$cat"
    }
    Start-Sleep -Seconds 3
    Write-Host "Tasks started. Check logs for output." -ForegroundColor Green
}
```
  </action>
  <verify>File exists at deploy/setup_scheduled_task.ps1</verify>
  <done>Setup script created with daily schedules for each category</done>
</task>

<task type="auto">
  <name>Task 2: Create management script</name>
  <files>deploy/manage_service.ps1</files>
  <action>
Create deploy/manage_service.ps1 based on reference pattern:

```powershell
# BrasilIntel - Service Management Script
# Provides start/stop/status/logs/run-now commands

param(
    [Parameter(Mandatory=$true)]
    [ValidateSet("start", "stop", "status", "remove", "run-now", "logs", "test")]
    [string]$Action,

    [ValidateSet("health", "dental", "group_life", "all")]
    [string]$Category = "all",

    [string]$TaskNamePrefix = "BrasilIntel",
    [string]$AppPath = "C:\BrasilIntel",
    [int]$LogLines = 50
)

$logsPath = "$AppPath\data\logs"

# Get task names based on category
function Get-TaskNames {
    if ($Category -eq "all") {
        return @("$TaskNamePrefix-health", "$TaskNamePrefix-dental", "$TaskNamePrefix-group_life")
    } else {
        return @("$TaskNamePrefix-$Category")
    }
}

switch ($Action) {
    "run-now" {
        $taskNames = Get-TaskNames
        foreach ($taskName in $taskNames) {
            Write-Host "Running $taskName now..." -ForegroundColor Cyan
            Start-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue
        }
        Start-Sleep -Seconds 2
        Write-Host "Tasks started. Check logs with: .\deploy\manage_service.ps1 -Action logs" -ForegroundColor Yellow
    }
    "start" {
        $taskNames = Get-TaskNames
        foreach ($taskName in $taskNames) {
            Write-Host "Enabling $taskName..." -ForegroundColor Cyan
            Enable-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue
        }
        Write-Host "Tasks enabled." -ForegroundColor Green
    }
    "stop" {
        $taskNames = Get-TaskNames
        foreach ($taskName in $taskNames) {
            Write-Host "Disabling $taskName..." -ForegroundColor Cyan
            Disable-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue
        }
        Write-Host "Tasks disabled." -ForegroundColor Green
    }
    "status" {
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "BrasilIntel - Status" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host ""

        $taskNames = Get-TaskNames
        foreach ($taskName in $taskNames) {
            $task = Get-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue
            if ($task) {
                $taskInfo = Get-ScheduledTaskInfo -TaskName $taskName
                $stateColor = switch ($task.State) {
                    "Ready" { "Green" }
                    "Running" { "Yellow" }
                    "Disabled" { "Red" }
                    default { "White" }
                }
                $resultColor = if ($taskInfo.LastTaskResult -eq 0) { "Green" } else { "Red" }

                Write-Host "Task: $taskName" -ForegroundColor White
                Write-Host "  State:       $($task.State)" -ForegroundColor $stateColor
                Write-Host "  Last Run:    $($taskInfo.LastRunTime)"
                Write-Host "  Last Result: $($taskInfo.LastTaskResult)" -ForegroundColor $resultColor
                Write-Host "  Next Run:    $($taskInfo.NextRunTime)"
                Write-Host ""
            } else {
                Write-Host "Task: $taskName - NOT FOUND" -ForegroundColor Red
                Write-Host ""
            }
        }

        # Show latest logs
        $latestLog = Get-ChildItem -Path $logsPath -Filter "*.log" -ErrorAction SilentlyContinue |
                     Sort-Object LastWriteTime -Descending |
                     Select-Object -First 1
        if ($latestLog) {
            Write-Host "Latest log: $($latestLog.Name)" -ForegroundColor White
            Write-Host "Log size:   $([math]::Round($latestLog.Length / 1KB, 2)) KB" -ForegroundColor White
        }
    }
    "remove" {
        $confirm = Read-Host "Remove all BrasilIntel scheduled tasks? (y/N)"
        if ($confirm -eq 'y' -or $confirm -eq 'Y') {
            $taskNames = @("$TaskNamePrefix-health", "$TaskNamePrefix-dental", "$TaskNamePrefix-group_life")
            foreach ($taskName in $taskNames) {
                Write-Host "Removing $taskName..." -ForegroundColor Yellow
                Stop-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue
                Unregister-ScheduledTask -TaskName $taskName -Confirm:$false -ErrorAction SilentlyContinue
            }
            Write-Host "Tasks removed." -ForegroundColor Green
        } else {
            Write-Host "Cancelled." -ForegroundColor Yellow
        }
    }
    "logs" {
        $filter = if ($Category -eq "all") { "run_*.log" } else { "run_$Category*.log" }
        $latestLog = Get-ChildItem -Path $logsPath -Filter $filter -ErrorAction SilentlyContinue |
                     Sort-Object LastWriteTime -Descending |
                     Select-Object -First 1

        if ($latestLog) {
            Write-Host "========================================" -ForegroundColor Cyan
            Write-Host "Latest Log: $($latestLog.Name)" -ForegroundColor Cyan
            Write-Host "========================================" -ForegroundColor Cyan
            Write-Host ""
            Get-Content $latestLog.FullName -Tail $LogLines
        } else {
            Write-Host "No log files found in $logsPath" -ForegroundColor Yellow
            Write-Host "Run a task first: .\deploy\manage_service.ps1 -Action run-now" -ForegroundColor White
        }
    }
    "test" {
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "BrasilIntel - Test Run" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "Testing API health endpoint..." -ForegroundColor Yellow

        Push-Location $AppPath
        try {
            & "$AppPath\venv\Scripts\python.exe" -c "import requests; r = requests.get('http://localhost:8000/api/health'); print(r.json())"
        } catch {
            Write-Host "Server not running. Starting test with uvicorn..." -ForegroundColor Yellow
            & "$AppPath\venv\Scripts\python.exe" -m uvicorn app.main:app --host 127.0.0.1 --port 8000
        } finally {
            Pop-Location
        }
    }
}
```
  </action>
  <verify>File exists at deploy/manage_service.ps1</verify>
  <done>Management script created with all required commands</done>
</task>

<task type="auto">
  <name>Task 3: Enhance health check endpoint</name>
  <files>app/main.py</files>
  <action>
Update the health check endpoint in app/main.py to check all dependencies:

```python
# Replace the existing health_check function with this enhanced version:

@app.get("/api/health", tags=["Health"])
def health_check(db: Session = Depends(get_db)) -> dict:
    """
    Enhanced health check endpoint.

    Checks:
    - Application status
    - Database connectivity
    - External service configuration
    - Data directory accessibility

    Returns detailed status for monitoring and diagnostics.
    """
    from datetime import datetime
    from sqlalchemy import text
    from app.config import get_settings
    import os

    settings = get_settings()

    health = {
        "status": "healthy",
        "service": "brasilintel",
        "version": "0.1.0",
        "timestamp": datetime.utcnow().isoformat(),
        "checks": {}
    }

    # Check database connectivity
    try:
        db.execute(text("SELECT 1"))
        health["checks"]["database"] = "ok"
    except Exception as e:
        health["status"] = "unhealthy"
        health["checks"]["database"] = f"error: {str(e)}"

    # Check data directory
    data_dir = settings.data_dir
    if os.path.isdir(data_dir) and os.access(data_dir, os.W_OK):
        health["checks"]["data_directory"] = "ok"
    else:
        health["status"] = "degraded"
        health["checks"]["data_directory"] = f"not writable: {data_dir}"

    # Check external service configuration
    services = {
        "azure_openai": settings.is_azure_openai_configured(),
        "microsoft_graph": settings.is_graph_configured(),
        "apify": settings.is_apify_configured(),
    }

    missing_services = [name for name, configured in services.items() if not configured]
    if missing_services:
        health["checks"]["external_services"] = f"not configured: {', '.join(missing_services)}"
        # Don't mark as unhealthy - services may be optional for some operations
    else:
        health["checks"]["external_services"] = "all configured"

    return health
```

Also add the get_db dependency import at the top if not present:
```python
from app.dependencies import get_db
from sqlalchemy.orm import Session
from fastapi import Depends
```
  </action>
  <verify>curl http://localhost:8000/api/health returns detailed status with checks</verify>
  <done>Health check enhanced with database, data directory, and service configuration checks</done>
</task>

</tasks>

<verification>
1. Scripts exist: `ls deploy/*.ps1`
2. Setup syntax: PowerShell -File deploy/setup_scheduled_task.ps1 -WhatIf
3. Health check: curl http://localhost:8000/api/health shows all checks
4. Health check includes: database, data_directory, external_services
</verification>

<success_criteria>
- deploy/setup_scheduled_task.ps1 creates tasks for health, dental, group_life categories
- Tasks scheduled for 6 AM, 7 AM, 8 AM respectively
- deploy/manage_service.ps1 supports start/stop/status/remove/run-now/logs/test commands
- Batch scripts created in deploy/ directory for each category
- Health check validates database, data directory, and service configuration
- Logs written to data/logs/ with date-stamped filenames
</success_criteria>

<output>
After completion, create `.planning/phases/02-vertical-slice-validation/02-09-SUMMARY.md`
</output>
