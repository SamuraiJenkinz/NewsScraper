---
phase: 02-vertical-slice-validation
plan: 08
type: execute
wave: 4
depends_on: [02-07]
files_modified:
  - Dockerfile
  - docker-compose.yml
  - .dockerignore
autonomous: true

must_haves:
  truths:
    - "Docker container runs FastAPI application on port 8000"
    - "SQLite database persisted via volume mount"
    - "Health check verifies container is operational"
  artifacts:
    - path: "Dockerfile"
      provides: "Multi-stage Docker build for FastAPI application"
      min_lines: 20
    - path: "docker-compose.yml"
      provides: "Docker Compose configuration with volume and environment"
      min_lines: 15
    - path: ".dockerignore"
      provides: "Files to exclude from Docker build context"
      min_lines: 10
  key_links:
    - from: "Dockerfile"
      to: "requirements.txt"
      via: "pip install"
      pattern: "requirements.txt"
    - from: "docker-compose.yml"
      to: ".env"
      via: "env_file directive"
      pattern: "env_file"
---

<objective>
Create Docker deployment configuration for local Windows 11 development.

Purpose: Enables containerized development and testing environment that matches production behavior with persistent SQLite storage.

Output: Dockerfile and docker-compose.yml ready for `docker compose up`.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-vertical-slice-validation/02-RESEARCH.md

# Application entry point
@app/main.py
@requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile</name>
  <files>Dockerfile</files>
  <action>
Create Dockerfile for FastAPI application based on research pattern:

```dockerfile
# BrasilIntel API Dockerfile
# Optimized for FastAPI with SQLite persistence

FROM python:3.11-slim AS base

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PYTHONPATH=/app

# Set working directory
WORKDIR /app

# Install system dependencies
# curl for healthcheck, gcc for any compiled dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies first for caching
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY app/ app/
COPY .env.example .env.example

# Create data directory for SQLite and logs
RUN mkdir -p /app/data/logs

# Create non-root user for security
RUN useradd --create-home --shell /bin/bash appuser \
    && chown -R appuser:appuser /app
USER appuser

# Expose port
EXPOSE 8000

# Health check using curl to hit /api/health endpoint
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8000/api/health || exit 1

# Run with uvicorn in exec form for proper signal handling
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```
  </action>
  <verify>docker build -t brasilintel:test . (should complete without errors)</verify>
  <done>Dockerfile created with Python 3.11, health check, and non-root user</done>
</task>

<task type="auto">
  <name>Task 2: Create docker-compose.yml</name>
  <files>docker-compose.yml</files>
  <action>
Create Docker Compose configuration:

```yaml
# BrasilIntel Docker Compose Configuration
# For local development on Windows 11

version: "3.8"

services:
  brasilintel:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: brasilintel-api
    ports:
      - "8000:8000"
    volumes:
      # Named volume for SQLite persistence (recommended over bind mount)
      - brasilintel-data:/app/data
      # Optional: Mount templates for live editing during development
      # - ./app/templates:/app/app/templates:ro
    env_file:
      - .env
    environment:
      # Override database path to use container's data directory
      - DATABASE_URL=sqlite:////app/data/brasilintel.db
      - DATA_DIR=/app/data
      - LOG_LEVEL=INFO
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# Named volume for data persistence
# Data survives container restarts and rebuilds
volumes:
  brasilintel-data:
    driver: local
```
  </action>
  <verify>docker compose config (validates YAML syntax)</verify>
  <done>docker-compose.yml created with named volume for SQLite persistence</done>
</task>

<task type="auto">
  <name>Task 3: Create .dockerignore</name>
  <files>.dockerignore</files>
  <action>
Create .dockerignore to exclude unnecessary files from build context:

```
# Git
.git
.gitignore

# Python
__pycache__
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
.venv/
ENV/
.eggs/
*.egg-info/
*.egg

# IDE
.idea/
.vscode/
*.swp
*.swo

# Testing
.pytest_cache/
.coverage
htmlcov/
.tox/

# Documentation
docs/
*.md
!README.md

# Planning files
.planning/
refchyt/

# Local data (use volume instead)
data/
*.db
*.sqlite
*.sqlite3

# Environment files (loaded separately)
.env
.env.*
!.env.example

# Docker
Dockerfile*
docker-compose*.yml
.docker/

# OS files
.DS_Store
Thumbs.db
*.log

# Miscellaneous
*.bak
*.tmp
*.temp
```
  </action>
  <verify>File exists and excludes .env, data/, venv/</verify>
  <done>.dockerignore created to minimize build context size</done>
</task>

</tasks>

<verification>
1. Build succeeds: `docker build -t brasilintel:test .`
2. Compose validates: `docker compose config`
3. Container starts: `docker compose up -d`
4. Health check passes: `docker compose ps` shows healthy status
5. API accessible: `curl http://localhost:8000/api/health`
6. Data persists: Stop container, restart, data still present
</verification>

<success_criteria>
- Dockerfile uses Python 3.11-slim base image
- pip install runs before copying application code (layer caching)
- Health check configured for /api/health endpoint
- Exec form CMD for proper signal handling
- docker-compose.yml uses named volume for SQLite persistence
- .env file loaded via env_file directive
- Container runs as non-root user for security
- .dockerignore excludes venv, data, .env, and planning files
</success_criteria>

<output>
After completion, create `.planning/phases/02-vertical-slice-validation/02-08-SUMMARY.md`
</output>
