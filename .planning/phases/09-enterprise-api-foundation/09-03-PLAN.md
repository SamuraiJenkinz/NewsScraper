---
phase: 09-enterprise-api-foundation
plan: 03
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - app/auth/__init__.py
  - app/auth/token_manager.py
  - scripts/test_auth.py
autonomous: true
user_setup:
  - service: mmc-core-api
    why: "OAuth2 client credentials for MMC Access Management API"
    env_vars:
      - name: MMC_API_BASE_URL
        source: "Apigee portal — staging: https://mmc-dallas-int-non-prod-ingress.mgti.mmc.com"
      - name: MMC_API_CLIENT_ID
        source: "Apigee portal — client credentials section"
      - name: MMC_API_CLIENT_SECRET
        source: "Apigee portal — client credentials section"

must_haves:
  truths:
    - "TokenManager.get_token() returns a valid JWT string when credentials are configured correctly"
    - "TokenManager.get_token() returns cached token on second call without network request (sub-100ms)"
    - "TokenManager.force_refresh() invalidates cache and acquires a fresh token"
    - "When credentials are missing, TokenManager.is_configured() returns False and get_token() returns None without crashing"
    - "Every token acquisition, refresh, and failure writes a record to the api_events table"
    - "Token is proactively refreshed when within 5 minutes of expiry (REFRESH_MARGIN_SECONDS=300)"
    - "401/403 errors return None immediately without retry; 429/5xx errors retry up to 3 times"
    - "scripts/test_auth.py validates the full auth lifecycle with structured output"
  artifacts:
    - path: "app/auth/__init__.py"
      provides: "Auth package initialization"
    - path: "app/auth/token_manager.py"
      provides: "OAuth2 client credentials TokenManager with retry, caching, and event logging"
      exports: ["TokenManager", "TokenInfo"]
      min_lines: 300
    - path: "scripts/test_auth.py"
      provides: "Standalone auth validation script with 4-step test suite"
      contains: "BrasilIntel"
  key_links:
    - from: "app/auth/token_manager.py"
      to: "app/config.py"
      via: "get_settings() for MMC credentials"
      pattern: "from app\\.config import get_settings"
    - from: "app/auth/token_manager.py"
      to: "app/database.py"
      via: "SessionLocal for event recording"
      pattern: "from app\\.database import SessionLocal"
    - from: "app/auth/token_manager.py"
      to: "app/models/api_event.py"
      via: "ApiEvent + ApiEventType for _record_event()"
      pattern: "from app\\.models\\.api_event import ApiEvent, ApiEventType"
    - from: "scripts/test_auth.py"
      to: "app/auth/token_manager.py"
      via: "TokenManager import for test execution"
      pattern: "from app\\.auth\\.token_manager import TokenManager"
---

<objective>
Port TokenManager from MDInsights into a new app/auth/ package and adapt test_auth.py for BrasilIntel, completing the OAuth2 authentication foundation.

Purpose: This is the keystone of Phase 9. TokenManager satisfies AUTH-01 (JWT acquisition), AUTH-02 (proactive refresh), AUTH-03 (event logging), and AUTH-04 (graceful degradation). Every enterprise API call in Phases 10-13 will call TokenManager.get_token() to obtain a valid JWT.

Output: Working TokenManager at app/auth/token_manager.py, validation script at scripts/test_auth.py. All four AUTH requirements verifiable.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\BrasilIntel\.planning\ROADMAP.md
@C:\BrasilIntel\.planning\STATE.md
@C:\BrasilIntel\.planning\phases\09-enterprise-api-foundation\09-CONTEXT.md
@C:\BrasilIntel\.planning\phases\09-enterprise-api-foundation\09-RESEARCH.md

Prior plan summaries (these plans must be complete before this one runs):
@C:\BrasilIntel\.planning\phases\09-enterprise-api-foundation\09-01-SUMMARY.md
@C:\BrasilIntel\.planning\phases\09-enterprise-api-foundation\09-02-SUMMARY.md

Source files to port FROM:
@C:\BrasilIntel\mdinsights\app\auth\token_manager.py (332 lines — port with zero domain changes)
@C:\BrasilIntel\mdinsights\scripts\test_auth.py (208 lines — adapt imports and branding)

Reference for import patterns:
@C:\BrasilIntel\app\config.py (has get_settings, mmc_* fields from Plan 09-01)
@C:\BrasilIntel\app\database.py (SessionLocal, Base, engine)
@C:\BrasilIntel\app\models\api_event.py (ApiEvent, ApiEventType from Plan 09-02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create app/auth/ package with TokenManager</name>
  <files>app/auth/__init__.py, app/auth/token_manager.py</files>
  <action>
**1. Create `app/auth/__init__.py`** — Empty file (or a single-line docstring `"""BrasilIntel enterprise API authentication."""`). This creates the auth package.

**2. Create `app/auth/token_manager.py`** — Port VERBATIM from MDInsights (`C:\BrasilIntel\mdinsights\app\auth\token_manager.py`). This file requires ZERO functional changes because:
- `from app.config import get_settings` — identical function name and pattern
- `from app.database import SessionLocal` — identical name
- `from app.models.api_event import ApiEvent, ApiEventType` — created by Plan 09-02
- Settings fields `mmc_api_base_url`, `mmc_api_client_id`, `mmc_api_client_secret`, `mmc_api_token_path` — created by Plan 09-01
- `settings.is_mmc_auth_configured()` — created by Plan 09-01

The ONLY change from MDInsights source: update the module docstring to say "BrasilIntel" instead of "MDInsights". Also update any Phase references in comments to match BrasilIntel's phase numbering (Phase 12 email in MDInsights = Phase 13 in BrasilIntel, Phase 13 admin in MDInsights = Phase 14 in BrasilIntel). These are comment-only changes.

Key implementation details to preserve exactly:
- `REFRESH_MARGIN_SECONDS = 300` (5-minute proactive refresh — AUTH-02)
- `TokenInfo` dataclass with `access_token`, `expires_at`, `token_type`
- `@retry` decorator with `stop_after_attempt(3)`, `wait_random_exponential(multiplier=1, min=2, max=10)`, `retry_if_exception_type((httpx.TimeoutException, httpx.NetworkError, httpx.HTTPStatusError))`, `reraise=False`
- `_record_event()` opens its OWN SessionLocal — never interferes with caller
- `_record_event()` swallows all exceptions — event recording never crashes token flow
- 401/403 returns None immediately (no retry)
- 429/5xx raises to trigger tenacity retry
- `force_refresh()` sets `_token = None` then calls `_acquire_token()`
- Security contract: NEVER logs client_id, client_secret, or raw token values

Both `import logging` AND `import structlog` are needed — `logging.WARNING` is passed to `before_sleep_log()`, while `structlog.get_logger()` is used for application logging.
  </action>
  <verify>
Run `python -c "from app.auth.token_manager import TokenManager, TokenInfo; tm = TokenManager(); print('configured:', tm.is_configured()); print('token_valid:', tm.is_token_valid); print('TokenManager imported OK')"` from project root. Should print `configured: False`, `token_valid: False`, `TokenManager imported OK`.
  </verify>
  <done>app/auth/ package exists. TokenManager is importable, reads credentials from Settings, has 5-minute refresh margin, tenacity retry on transient errors, event recording to api_events, and graceful None return on auth failure.</done>
</task>

<task type="auto">
  <name>Task 2: Port test_auth.py for BrasilIntel</name>
  <files>scripts/test_auth.py</files>
  <action>
Port `scripts/test_auth.py` from MDInsights (`C:\BrasilIntel\mdinsights\scripts\test_auth.py`) with these specific adaptations:

**Import changes (lines 37-40 in MDInsights):**
Replace the model import block:
```python
# MDInsights:
import app.models.news_article  # noqa: F401
import app.models.source  # noqa: F401
import app.models.run  # noqa: F401
import app.models.api_event  # noqa: F401
```

With BrasilIntel's model names:
```python
# BrasilIntel:
import app.models.insurer  # noqa: F401
import app.models.run  # noqa: F401
import app.models.news_item  # noqa: F401
import app.models.api_event  # noqa: F401
import app.models.factiva_config  # noqa: F401
import app.models.equity_ticker  # noqa: F401
```

**Branding changes:**
- Line 173: `"MDInsights — MMC Core API Auth Test"` → `"BrasilIntel — MMC Core API Auth Test"`
- Line 201: `"The TokenManager is ready for use in Phase 10-12 enterprise API calls."` → `"The TokenManager is ready for use in Phase 10-13 enterprise API calls."`

**logging_config import:**
MDInsights has `from app.logging_config import configure_logging`. BrasilIntel may not have this module. Check if `app/logging_config.py` exists. If NOT, replace the `configure_logging(log_level="WARNING")` call with:
```python
import logging
logging.basicConfig(level=logging.WARNING)
```

All other code is identical — the same 4-step test:
1. Check config (mmc_api_base_url, mmc_api_client_id, mmc_api_client_secret)
2. Acquire token (measures latency)
3. Verify cache hit (second call < 100ms)
4. Force refresh (invalidate + re-acquire)

Exit codes: 0=pass, 1=token failure, 2=missing config.
  </action>
  <verify>
1. Run `python scripts/test_auth.py` from project root. Without MMC credentials configured, it should print the config check, report "CONFIGURATION MISSING", and exit with code 2 (not crash).
2. The script should NOT exit with an unhandled exception — it must handle missing credentials gracefully with a clear error message and exit code 2.
  </verify>
  <done>scripts/test_auth.py runs the 4-step auth validation suite. With no credentials, exits cleanly with code 2 and helpful error message. With valid credentials, exercises full token lifecycle (acquire, cache, refresh).</done>
</task>

</tasks>

<verification>
**AUTH-01 verification:** `from app.auth.token_manager import TokenManager; tm = TokenManager()` — TokenManager reads OAuth2 credentials from Settings and can POST to Access Management API token endpoint.

**AUTH-02 verification:** `REFRESH_MARGIN_SECONDS = 300` constant in TokenManager, `is_token_valid` property checks `expires_at > time.time() + 300`.

**AUTH-03 verification:** `_record_event()` method writes ApiEvent records to api_events table for TOKEN_ACQUIRED, TOKEN_REFRESHED, and TOKEN_FAILED events.

**AUTH-04 verification:** `python scripts/test_auth.py` with no credentials exits with code 2 (graceful). TokenManager.get_token() returns None (not raises) when auth fails.

**Integration verification:** `python -c "from app.auth.token_manager import TokenManager; from app.models.api_event import ApiEvent, ApiEventType; from app.config import get_settings; s = get_settings(); print('Auth configured:', s.is_mmc_auth_configured()); tm = TokenManager(); print('TM configured:', tm.is_configured()); print('All Phase 9 components integrated')"` — prints False, False, integration message.
</verification>

<success_criteria>
- TokenManager importable from app.auth.token_manager
- TokenManager reads MMC credentials from Settings (mmc_api_base_url, mmc_api_client_id, mmc_api_client_secret, mmc_api_token_path)
- REFRESH_MARGIN_SECONDS = 300 (5-minute proactive refresh)
- _record_event() writes to api_events table independently (own session, swallows errors)
- 401/403 = no retry, returns None; 429/5xx = retry up to 3x with exponential backoff
- force_refresh() invalidates cache and re-acquires
- scripts/test_auth.py handles missing credentials gracefully (exit code 2)
- No secrets ever logged or stored in api_events detail column
</success_criteria>

<output>
After completion, create `.planning/phases/09-enterprise-api-foundation/09-03-SUMMARY.md`
</output>
