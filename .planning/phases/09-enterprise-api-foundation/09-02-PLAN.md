---
phase: 09-enterprise-api-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/models/api_event.py
  - app/models/factiva_config.py
  - app/models/equity_ticker.py
  - app/models/__init__.py
  - app/main.py
  - scripts/migrate_007_enterprise_api_tables.py
autonomous: true

must_haves:
  truths:
    - "api_events table exists in the database with columns: id, event_type, api_name, timestamp, success, detail, run_id"
    - "factiva_config table exists with a seeded row (id=1) containing default industry codes i82,i832 and keywords insurance reinsurance"
    - "equity_tickers table exists with exchange default BVMF (not NYSE)"
    - "ApiEventType enum has all 9 event types defined upfront"
    - "All three new models are importable from app.models"
  artifacts:
    - path: "app/models/api_event.py"
      provides: "ApiEvent ORM model and ApiEventType enum"
      exports: ["ApiEvent", "ApiEventType"]
    - path: "app/models/factiva_config.py"
      provides: "FactivaConfig ORM model for admin-configurable query params"
      exports: ["FactivaConfig"]
    - path: "app/models/equity_ticker.py"
      provides: "EquityTicker ORM model for entity-to-ticker mappings"
      exports: ["EquityTicker"]
    - path: "scripts/migrate_007_enterprise_api_tables.py"
      provides: "Migration script creating 3 tables and seeding factiva_config"
      contains: "CREATE TABLE IF NOT EXISTS api_events"
    - path: "app/models/__init__.py"
      provides: "Package exports for all models including new Phase 9 models"
      contains: "ApiEvent"
    - path: "app/main.py"
      provides: "Model registration for Base.metadata.create_all"
      contains: "api_event"
  key_links:
    - from: "app/models/api_event.py"
      to: "app/database.py"
      via: "Base import for ORM registration"
      pattern: "from app\\.database import Base"
    - from: "app/models/api_event.py"
      to: "app/models/run.py"
      via: "ForeignKey to runs.id"
      pattern: "ForeignKey.*runs\\.id"
    - from: "app/main.py"
      to: "app/models/api_event.py"
      via: "noqa import for metadata registration"
      pattern: "from app\\.models import.*api_event"
---

<objective>
Port the three enterprise API ORM models from MDInsights (ApiEvent, FactivaConfig, EquityTicker), register them in the models package and main.py, and create the database migration script.

Purpose: These three tables are the persistent data layer for all enterprise API integration in Phases 9-14. The api_events table enables AUTH-03 (observability). The FactivaConfig and EquityTicker tables are needed by Phases 10 and 12 respectively. Creating them all now avoids per-phase migration scripts.

Output: 3 new model files, updated __init__.py, updated main.py model imports, migration script 007.
</objective>

<execution_context>
@C:\Users\taylo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\taylo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\BrasilIntel\.planning\ROADMAP.md
@C:\BrasilIntel\.planning\STATE.md
@C:\BrasilIntel\.planning\phases\09-enterprise-api-foundation\09-CONTEXT.md
@C:\BrasilIntel\.planning\phases\09-enterprise-api-foundation\09-RESEARCH.md

Source files to port FROM:
@C:\BrasilIntel\mdinsights\app\models\api_event.py
@C:\BrasilIntel\mdinsights\app\models\factiva_config.py
@C:\BrasilIntel\mdinsights\app\models\equity_ticker.py

Target files to modify:
@C:\BrasilIntel\app\models\__init__.py
@C:\BrasilIntel\app\main.py

Reference for conventions:
@C:\BrasilIntel\app\database.py
@C:\BrasilIntel\scripts\migrate_006_scheduler_tracking.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port three ORM models from MDInsights</name>
  <files>app/models/api_event.py, app/models/factiva_config.py, app/models/equity_ticker.py</files>
  <action>
Create three new model files by porting from MDInsights with these specific changes:

**1. `app/models/api_event.py`** — Copy VERBATIM from MDInsights (`C:\BrasilIntel\mdinsights\app\models\api_event.py`). Change ONLY the module docstring to say "BrasilIntel" instead of "MDInsights". The import `from app.database import Base` is identical in both projects. The `ForeignKey("runs.id")` works because BrasilIntel's Run model has the same table name. Keep all 9 ApiEventType enum values (TOKEN_ACQUIRED, TOKEN_REFRESHED, TOKEN_FAILED, NEWS_FETCH, NEWS_FALLBACK, EQUITY_FETCH, EQUITY_FALLBACK, EMAIL_SENT, EMAIL_FALLBACK).

**2. `app/models/factiva_config.py`** — Copy VERBATIM from MDInsights (`C:\BrasilIntel\mdinsights\app\models\factiva_config.py`). Change ONLY the module docstring to say "BrasilIntel" instead of "MDInsights". All defaults are confirmed correct per CONTEXT.md (industry_codes="i82,i832", keywords="insurance reinsurance", company_codes="MM", page_size=25).

**3. `app/models/equity_ticker.py`** — Copy from MDInsights (`C:\BrasilIntel\mdinsights\app\models\equity_ticker.py`) with ONE functional change: change the `exchange` column default from `"NYSE"` to `"BVMF"` (B3 — the Brazilian stock exchange). Also update the column comment to include "BVMF" as the first example: `comment="Exchange code (e.g. 'BVMF', 'NYSE', 'NASDAQ')"`. Update docstring to say "BrasilIntel" instead of "MDInsights".

Then update the existing files:

**4. `app/models/__init__.py`** — Add imports for the three new models:
```python
from app.models.api_event import ApiEvent, ApiEventType
from app.models.factiva_config import FactivaConfig
from app.models.equity_ticker import EquityTicker
```
Add them to the `__all__` list: `["Insurer", "Run", "NewsItem", "ApiEvent", "ApiEventType", "FactivaConfig", "EquityTicker"]`

**5. `app/main.py`** — In the model registration block (around line 18, where `from app.models import insurer, run, news_item` exists), add:
```python
from app.models import api_event, factiva_config, equity_ticker  # noqa: F401
```
This ensures Base.metadata.create_all() creates the new tables on startup.
  </action>
  <verify>
Run `python -c "from app.models import ApiEvent, ApiEventType, FactivaConfig, EquityTicker; print('ApiEvent:', ApiEvent.__tablename__); print('FactivaConfig:', FactivaConfig.__tablename__); print('EquityTicker:', EquityTicker.__tablename__); print('Event types:', len(ApiEventType)); print('All imports OK')"` from project root. Should print table names "api_events", "factiva_config", "equity_tickers", 9 event types, and "All imports OK".
  </verify>
  <done>Three model files exist with correct schemas. ApiEventType has 9 values. EquityTicker defaults exchange to "BVMF". Models are registered in __init__.py and main.py.</done>
</task>

<task type="auto">
  <name>Task 2: Create and run migration 007 for enterprise API tables</name>
  <files>scripts/migrate_007_enterprise_api_tables.py</files>
  <action>
Create `scripts/migrate_007_enterprise_api_tables.py` following the pattern from `migrate_006_scheduler_tracking.py` (sqlite3 raw SQL, idempotent, CREATE TABLE IF NOT EXISTS).

The migration script must:

1. **Create api_events table:**
```sql
CREATE TABLE IF NOT EXISTS api_events (
    id          INTEGER PRIMARY KEY AUTOINCREMENT,
    event_type  VARCHAR(50) NOT NULL,
    api_name    VARCHAR(50) NOT NULL,
    timestamp   DATETIME NOT NULL,
    success     BOOLEAN NOT NULL,
    detail      TEXT,
    run_id      INTEGER REFERENCES runs(id)
);
```

2. **Create factiva_config table:**
```sql
CREATE TABLE IF NOT EXISTS factiva_config (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    industry_codes  VARCHAR(500) NOT NULL DEFAULT 'i82,i832',
    company_codes   VARCHAR(500) NOT NULL DEFAULT 'MM',
    keywords        VARCHAR(500) NOT NULL DEFAULT 'insurance reinsurance',
    page_size       INTEGER NOT NULL DEFAULT 25,
    enabled         BOOLEAN NOT NULL DEFAULT 1,
    updated_at      DATETIME,
    updated_by      VARCHAR(100)
);
```

3. **Seed factiva_config row 1 (idempotent):**
```sql
INSERT OR IGNORE INTO factiva_config
    (id, industry_codes, company_codes, keywords, page_size, enabled)
VALUES
    (1, 'i82,i832', 'MM', 'insurance reinsurance', 25, 1);
```

4. **Create equity_tickers table:**
```sql
CREATE TABLE IF NOT EXISTS equity_tickers (
    id          INTEGER PRIMARY KEY AUTOINCREMENT,
    entity_name VARCHAR(200) UNIQUE NOT NULL,
    ticker      VARCHAR(20) NOT NULL,
    exchange    VARCHAR(20) NOT NULL DEFAULT 'BVMF',
    enabled     BOOLEAN NOT NULL DEFAULT 1,
    updated_at  DATETIME,
    updated_by  VARCHAR(100)
);
```

Follow the existing migration script pattern:
- `DB_PATH = Path(__file__).parent.parent / "data" / "brasilintel.db"`
- Check if DB exists (exit 0 if not — it will be created on app startup)
- Print progress for each table created
- Verify table existence after creation
- The script must be safe to re-run (idempotent)

After creating the script, run it: `python scripts/migrate_007_enterprise_api_tables.py`

Then verify the tables exist by running:
`python -c "import sqlite3; conn = sqlite3.connect('data/brasilintel.db'); cursor = conn.cursor(); cursor.execute('SELECT name FROM sqlite_master WHERE type=\"table\" AND name IN (\"api_events\", \"factiva_config\", \"equity_tickers\")'); tables = [r[0] for r in cursor.fetchall()]; print('Tables:', tables); cursor.execute('SELECT * FROM factiva_config WHERE id=1'); row = cursor.fetchone(); print('Seed row:', row); conn.close()"`
  </action>
  <verify>
1. `python scripts/migrate_007_enterprise_api_tables.py` runs without errors and prints creation/skip messages.
2. Running it a SECOND time is safe (idempotent — all tables already exist).
3. Database query confirms: api_events, factiva_config, equity_tickers tables exist. factiva_config has seeded row with id=1, industry_codes="i82,i832", keywords="insurance reinsurance".
4. equity_tickers has exchange default "BVMF" (verify with PRAGMA table_info).
  </verify>
  <done>Migration 007 creates 3 enterprise API tables. factiva_config is seeded with row id=1. All tables are idempotent (safe to re-run). equity_tickers defaults exchange to BVMF.</done>
</task>

</tasks>

<verification>
1. All three models importable: `from app.models import ApiEvent, ApiEventType, FactivaConfig, EquityTicker`
2. ApiEventType has exactly 9 members
3. EquityTicker exchange column defaults to "BVMF" (not "NYSE")
4. Database has all three tables with correct schemas
5. factiva_config row 1 is seeded with expected defaults
6. Migration script is idempotent (can re-run safely)
7. App starts cleanly: `python -c "from app.main import app; print('App loaded OK')"`
</verification>

<success_criteria>
- api_events, factiva_config, equity_tickers tables exist in the database
- ApiEvent model has ForeignKey to runs.id
- ApiEventType enum has all 9 event types (TOKEN_*, NEWS_*, EQUITY_*, EMAIL_*)
- FactivaConfig seeded with defaults (i82,i832 / MM / insurance reinsurance / 25 / enabled)
- EquityTicker exchange defaults to "BVMF"
- Models registered in __init__.py and main.py (app startup creates tables automatically)
- Migration 007 runs cleanly and is idempotent
</success_criteria>

<output>
After completion, create `.planning/phases/09-enterprise-api-foundation/09-02-SUMMARY.md`
</output>
