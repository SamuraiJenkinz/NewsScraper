# Milestone v1.1: Enterprise API Integration

**Status:** SHIPPED 2026-02-20
**Phases:** 9-14
**Total Plans:** 17

## Overview

Replace Apify web scraping with Factiva/Dow Jones as the sole news source, add inline equity price data for tracked Brazilian insurance companies, extend admin dashboard with enterprise API visibility, and clean up legacy Apify infrastructure — porting the proven enterprise integration patterns from MDInsights into BrasilIntel.

## Phases

### Phase 9: Enterprise API Foundation

**Goal**: The system can authenticate with the MMC Core API platform and all API activity is observable through a persistent event log
**Depends on**: Phase 8 (v1.0 complete)
**Plans**: 3 plans

Plans:
- [x] 09-01: Config expansion — MMC Core API credential fields, helper methods, tenacity dependency, .env.example
- [x] 09-02: ORM models + migration — ApiEvent, FactivaConfig, EquityTicker models, migration 007, main.py registration
- [x] 09-03: TokenManager + test_auth.py — OAuth2 client credentials auth, proactive refresh, event logging, validation script

**Details:**
- 8 mmc_* Settings fields with 3 granular is_mmc_*_configured() guards
- ApiEvent ORM with 9-value ApiEventType enum for full API observability
- FactivaConfig seeded with Brazilian insurance industry codes (i82, i8200, i82001, i82002, i82003)
- EquityTicker with BVMF default exchange for B3 Brazilian market
- TokenManager: OAuth2 client credentials, 5-min proactive refresh, tenacity retry, independent session for event recording

### Phase 10: Factiva News Collection

**Goal**: The pipeline collects a batch of Brazilian insurance news from Factiva via MMC Core API, fetches full article bodies, deduplicates, and normalizes articles into BrasilIntel's NewsItem schema
**Depends on**: Phase 9
**Plans**: 3 plans

Plans:
- [x] 10-01: FactivaCollector — complete API client with search, article body fetch, normalization, ApiEvent recording, and FactivaConfig seed script
- [x] 10-02: ArticleDeduplicator — sentence-transformers semantic dedup with UnionFind grouping, add sentence-transformers dependency
- [x] 10-03: Integration test — test_factiva.py end-to-end validation (collect, URL dedup, semantic dedup, field validation)

**Details:**
- FactivaCollector: 453 lines, X-Api-Key auth, 48-hour window, retry decorator, SOURCE_LABEL="Factiva"
- ArticleDeduplicator: 229 lines, UnionFind clustering, 0.85 cosine similarity threshold, lazy model loading
- 9 Portuguese keywords (seguro, seguradora, resseguro, etc.) for broad coverage
- page_size=50 default, MAX_ARTICLES=100 hard cap

### Phase 11: Insurer Matching Pipeline

**Goal**: Every Factiva article is matched to one or more of the 897 tracked insurers and Factiva is the sole active news collection path in the pipeline
**Depends on**: Phase 10
**Plans**: 3 plans

Plans:
- [x] 11-01: Deterministic insurer matcher — MatchResult schema + InsurerMatcher with name/search_term word-boundary matching, Portuguese accent normalization
- [x] 11-02: AI-assisted insurer matcher — AIInsurerMatcher with Azure OpenAI structured output for ambiguous articles, ApiEvent logging
- [x] 11-03: Pipeline integration — rewrite runs.py to use FactivaCollector + dedup + insurer matching, remove Apify from active flow, sentinel insurer for unmatched

**Details:**
- Deterministic: NFKD normalization, word-boundary regex, 4-char threshold for short names, confidence scoring
- AI: structured output via client.beta.chat.completions.parse, hallucination guard, MAX_INSURER_CONTEXT=200
- Sentinel "Noticias Gerais" (ANS 000000) ensures no article lost
- 3-insurer cap per article, category-filtered matching
- Pipeline: Factiva → URL dedup → semantic dedup → insurer match → classify → store

### Phase 12: Equity Price Enrichment

**Goal**: Tracked Brazilian insurance companies display inline equity data (ticker, price, change%) in both browser and email reports
**Depends on**: Phase 9
**Plans**: 3 plans

Plans:
- [x] 12-01: EquityPriceClient service port + pipeline equity enrichment integration
- [x] 12-02: Admin ticker CRUD routes, equity.html template, sidebar nav, seed defaults
- [x] 12-03: Report equity chip display (email-compatible inline styles in report_professional.html)

**Details:**
- EquityPriceClient: direct port from MDInsights, BVMF default exchange, per-run ticker caching
- Admin: full CRUD at /admin/equity, 5 default Brazilian insurer tickers (BBSE3, SULA11, PSSA3, IRBR3, CXSE3)
- Reports: R$ format, HTML entity arrows (&#9650; &#9660;), inline-block layout, inline styles only for email

### Phase 13: Admin Dashboard Extensions

**Goal**: The admin dashboard surfaces enterprise API health, exposes credential and query configuration, and labels Factiva-sourced articles
**Depends on**: Phase 9, Phase 12
**Plans**: 3 plans

Plans:
- [x] 13-01: Enterprise API health panel + fallback event log on dashboard (ADMN-17)
- [x] 13-02: Enterprise Config credentials page + Factiva query config page with date range (ADMN-18, ADMN-19)
- [x] 13-03: Factiva source badges in report templates (ADMN-22)

**Details:**
- Health panel: traffic light indicators (green/yellow/red/gray), separate success/failure timestamps, fallback event log
- Enterprise Config: .env file write with secret masking, settings cache clear
- Factiva Config: industry codes, keywords, date range (24h/48h/7d), page size, enabled toggle
- Source badges: Dow Jones blue (#0077c8), inline styles, conditional for Factiva only

### Phase 14: Apify Cleanup

**Goal**: All Apify scraping infrastructure is removed from the codebase and the project reflects Factiva as the only news collection mechanism
**Depends on**: Phase 11 (Factiva pipeline confirmed working)
**Plans**: 2 plans

Plans:
- [x] 14-01: Delete Apify source files, dead services (scraper, batch_processor, relevance_scorer), dead tests, and remove apify-client/feedparser from requirements.txt
- [x] 14-02: Clean config, pipeline, admin UI of Apify/scraping references; update .env.example and docs; validate boot

**Details:**
- 14 files removed (9 Apify source classes, 3 dead services, 2 dead tests) — 2,584 lines
- 10 files cleaned (~320 lines removed) — config, pipeline, admin UI, .env.example, docs
- Total: 24 files modified, ~2,900 lines deleted
- Zero import errors, FastAPI boots successfully

---

## Milestone Summary

**Key Decisions:**
- Factiva over Apify: Enterprise Dow Jones feed more reliable than web scraping; proven in MDInsights
- Port from MDInsights: Adapt enterprise modules directly (TokenManager, FactivaCollector, EquityPriceClient)
- Industry codes + keywords: Batch Factiva query with post-hoc AI insurer matching (not per-insurer queries)
- Stay with Graph API: Enterprise email delivery removed from scope — Graph API sufficient
- Phase renumber: Old Phase 13 (Enterprise Email) removed, 14→13, 15→14
- Inline styles only: All new UI elements (equity chips, Factiva badges) use inline styles for Outlook/Gmail
- R$ Brazilian Real format: Equity chips show R$ not $ for B3 market

**Issues Resolved:**
- Complete Apify elimination: 2,900 lines removed with zero import errors
- Portuguese accent handling: NFKD normalization for insurer name matching
- Email compatibility: Inline styles for equity chips and Factiva badges
- Token refresh: Proactive 5-minute margin prevents mid-request expiry

**Issues Deferred:**
- MMC staging credential validation (requires live Apigee access)
- Email visual QA in real Outlook/Gmail clients
- Sentinel insurer noise filtering in admin dashboard
- AI matching cost monitoring at production volume

**Technical Debt Incurred:**
- Phase 13 missing formal VERIFICATION.md (plans self-verified in summaries)
- Migration 008 must run manually before production deployment
- First-run equity ticker seeding required

---

_For current project status, see .planning/ROADMAP.md_
